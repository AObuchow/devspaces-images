======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> c1ba9c0a40c
STEP 3/23: ARG BOOTSTRAP=true
--> 3f3a5e58c3a
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 2477abab1e1
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 73a9cafff4f
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 97acb20dd1d
STEP 7/23: ARG ALLOWED_TAGS=""
--> af339f855aa
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 512b18a795e
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 19507afd6dc
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> fd91fc0d2dc
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64                       
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64             
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.x86_64                
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.x86_64                 
  criu-3.15-3.module+el8.6.0+16771+28dfca77.x86_64                              
  fuse-common-3.3.0-15.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.x86_64                     
  fuse3-3.3.0-15.el8.x86_64                                                     
  fuse3-libs-3.3.0-15.el8.x86_64                                                
  iptables-libs-1.8.4-22.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-37.2-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.x86_64                         
  nftables-1:0.9.3-25.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.x86_64                           
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.x86_64                         
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Installing collected packages: toml, argcomplete, xmltodict, PyYAML, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 77df9e0d195
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 08f50704182
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> cc744bcd553
STEP 14/23: COPY ./VERSION /
--> 47f1751b7d0
STEP 15/23: COPY ./devfiles /build/devfiles
--> 76cfad1ef8a
STEP 16/23: WORKDIR /build/
--> a107e33fe72
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 9.536s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 1.878s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> ed29542ad04
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 5d9abcb35c0
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> a0acc5982da
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 1cd81301591
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 9b60e080123
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> d8e56e6a5f9
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 03c9caa76d5
Successfully tagged localhost/devfileregistry:tmp
03c9caa76d50096d0ad54bdb5b1df4d2ddda6c6aa8ad1d6dc1f8bcb06103f789
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: 03c9caa76d50096d0ad54bdb5b1df4d2ddda6c6aa8ad1d6dc1f8bcb06103f789
Deleted: d8e56e6a5f91318987b0632cfdde5e147af90bdb90697a2c917bec51f97f933d
Deleted: 9b60e0801239dbd0cd2f1eee0b7ae21a9b3469f5f2e90237c9bb247d0e2391de
Deleted: 1cd813015917cc65092717cd4e5c0eb132a2866a06b230dda0123b530e0aa157
Deleted: a0acc5982da90d8d980493b3ed6a45a3a1e40185fcbcffc62e3bf8350dd18405
Deleted: 5d9abcb35c006dbb1771800864f7c157089dd04e536d1ad7c1c98462628e48d0
Deleted: ed29542ad0434d0a8a061bcb21a9c2b424ea4f4122bfd89d9aaa648b6617e4a1
Deleted: a107e33fe7267cc6527a36af9307b58ec86f99ae917421b9eb6fa00b72252d99
Deleted: 76cfad1ef8ade33d58819a85f101d633248014592508e603034eccc70dcf5964
Deleted: 47f1751b7d0b6d613f40e6ce513749ff718d76f47c461a2e3952b6b25d9a7fb3
Deleted: cc744bcd55359cea1ee3efdfe2edc81e90b8824b05e0d2d7ee049a67a85e1434
Deleted: 08f5070418233a06a0e36db6f553ae5e90e28755bf5369e292c920cab3da4343
Deleted: 77df9e0d1950797112622238718cb2247dd2a93c6b1178792df021d21d24d847
Deleted: fd91fc0d2dcc2b34a825ca3c6e2c2f3a3ab482dcb929e087095d0674315ea3ed
Deleted: 19507afd6dcc8c373c9ae3935ad1223483cfa5fab478591862d68dcca0a8dde3
Deleted: 512b18a795ec22b52e5a6c5190b68e6bb414371ce0e96c868ffc6137d58fc5c9
Deleted: af339f855aa17bddec931887abb49f52a75947416c255f409832b64e5caaaf0f
Deleted: 97acb20dd1df4d13c2e60b980d0cf20da1c823555c05e16d7ec746798a19a723
Deleted: 73a9cafff4f6395ba0f95bd65edb5aafe94b590f9e211891682ecfb4faac000b
Deleted: 2477abab1e1579c63f13c829d0c0b89b72d55d5edda36680331f3169d1d1890d
Deleted: 3f3a5e58c3a3291c16d2c9ed0c9d567112b2e55139d90f0d17427ec39ab89cc8
Deleted: c1ba9c0a40cb752695d36a6058c4ecd9d2f6819e9ad19d76fdae18f1744b01f3
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
