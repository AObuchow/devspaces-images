======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 2ff4a0781cb
STEP 3/23: ARG BOOTSTRAP=true
--> 6d350890881
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 19000006909
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 3685c43bd1a
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 5a2b7724601
STEP 7/23: ARG ALLOWED_TAGS=""
--> 1b93fcec95e
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 9b61f618e77
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 9236a9d35f3
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> f107a51d2d4
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  dnf-4.7.0-11.el8.noarch                                                       
  dnf-data-4.7.0-11.el8.noarch                                                  
  nodejs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le                      
  nodejs-docs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.noarch                  
  nodejs-full-i18n-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le            
  npm-1:6.14.17-1.14.20.1.2.module+el8.7.0+16991+b0a68a3e.ppc64le               
  python3-dnf-4.7.0-11.el8.noarch                                               
  python38-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                       
  python38-devel-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                 
  python38-libs-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                  
  python38-pip-19.3.1-6.module+el8.7.0+15823+8950cfa7.noarch                    
  tar-2:1.30-6.el8.ppc64le                                                      
  yum-4.7.0-11.el8.noarch                                                       
Installed:
  containers-common-2:1-43.module+el8.7.0+17064+3b31f55c.ppc64le                
  criu-3.15-3.module+el8.7.0+17064+3b31f55c.ppc64le                             
  fuse-common-3.3.0-16.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.7.0+17064+3b31f55c.ppc64le                    
  fuse3-3.3.0-16.el8.ppc64le                                                    
  fuse3-libs-3.3.0-16.el8.ppc64le                                               
  iptables-libs-1.8.4-23.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-41.0-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  nftables-1:0.9.3-26.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  rpm-plugin-systemd-inhibit-4.14.3-23.el8.ppc64le                              
  runc-1:1.1.4-1.module+el8.7.0+17064+3b31f55c.ppc64le                          
  skopeo-2:1.9.3-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.7.0+17064+3b31f55c.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=ec0e33183a76afc40a3e1e67e44ea1faec3449e6147755f873f737202be21366
  Stored in directory: /tmp/pip-ephem-wheel-cache-_f3ai208/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: toml, argcomplete, xmltodict, PyYAML, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.13
yq: yq 3.1.0
jq: jq-1.6
--> 37b42035fe8
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> e75c05f54c2
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> b21599641fd
STEP 14/23: COPY ./VERSION /
--> a308eb563c9
STEP 15/23: COPY ./devfiles /build/devfiles
--> f517c2e6f11
STEP 16/23: WORKDIR /build/
--> a989517128e
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 183 contributors and audited 120 packages in 9.3s

5 packages are looking for funding
  run `npm fund` for details

found 1 high severity vulnerability
  run `npm audit fix` to fix them, or `npm audit` for details
+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.869s

5 packages are looking for funding
  run `npm fund` for details

found 5 high severity vulnerabilities
  run `npm audit fix` to fix them, or `npm audit` for details
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> f4b629c3826
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> adeb9de9f58
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.5 PASS - 3.5 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.5 PASS - 3.5 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.5 PASS - 3.5 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.5 PASS - 3.5 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.5 PASS - 3.5 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 93455b81d76
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/TP__cpp__c-plus-plus/meta.yaml'
Checking devfile 'devfiles/TP__dotnet__dotnet-web-simple/meta.yaml'
Checking devfile 'devfiles/TP__go__golang-health-check/meta.yaml'
Checking devfile 'devfiles/TP__php__php-hello-world/meta.yaml'
Checking devfile 'devfiles/java11-maven-lombok__lombok-project-sample/meta.yaml'
Checking devfile 'devfiles/java11-maven-quarkus__quarkus-quickstarts/meta.yaml'
Checking devfile 'devfiles/nodejs__nodejs-mongodb-sample/meta.yaml'
Checking devfile 'devfiles/nodejs__web-nodejs-sample/meta.yaml'
Checking devfile 'devfiles/python__python-hello-world/meta.yaml'
--> 21fe59e0bd3
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> cdd29c1ec8c
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 3e537b33091
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> ca21b532083
Successfully tagged localhost/devfileregistry:tmp
ca21b532083aeb754634ab013dd4ccd09beee5d900556d3269ef20298f468a20
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: ca21b532083aeb754634ab013dd4ccd09beee5d900556d3269ef20298f468a20
Deleted: 3e537b33091f9298c6238caff2d9d8925ef557d10d99bb8ccc1633c8835f7cfd
Deleted: cdd29c1ec8ccfd2f5cab718f3fed4fefe2eed855299ad9d1409ed1cdf8069d29
Deleted: 21fe59e0bd38758d1ff5d0f68321e3e1f64d3c76877db3deb5b8b194cad92891
Deleted: 93455b81d76e7a13001afda1882ac54173d881b4a68429e5726f8726d974acc7
Deleted: adeb9de9f58cebb0d67e987940d2118aa5bf7daaabbff9cad17cc5052790bab5
Deleted: f4b629c38260c01cce2fd0f88ad669d40aadf2f921c92155b7823d7170a0374b
Deleted: a989517128eab4ffbc4640d9dfefc209b5083c65730793705389880fa02d9dbf
Deleted: f517c2e6f11d92e92aca26476837b6911fa8c048fcb12883a03077475bec3684
Deleted: a308eb563c947768029c1ecbd975769ae0f6dc6fba3aeab7b3d86ffdd7596b47
Deleted: b21599641fd2aa20261d122acaeb66749ab64d82f3c950d82fca92d59194ccbf
Deleted: e75c05f54c2fb63d79142b0c8b3bf149ede10bb71b204cc5f1e65f3625b237ad
Deleted: 37b42035fe8ffc401b262dddbb134261d906d9efa93fc370a548538c692e006c
Deleted: f107a51d2d46dd50aa1b5418fd5cb068b3e5d98f2b9e26b6460efa8bb09f0261
Deleted: 9236a9d35f348305600ba970cecf6d42bd6200719b444be807ec13f1c3a3c4af
Deleted: 9b61f618e77a0151c7c4b2ffe37de78372fe01a94b7cf9fcaba371032725c4a8
Deleted: 1b93fcec95e8ea75e5c7aedd26591f52913a8f7a041eec771b13610ec6ae60ec
Deleted: 5a2b7724601e0eb376cda3a9a6173486c9adef10d23660c1f9ed12c1e148911e
Deleted: 3685c43bd1ae06905cfc3b98e85a17a6abad1d95aac44c5bcda1d16edecd8fc2
Deleted: 19000006909d02b4c6ce59d580bd501d09940fcc8f33a892babfac1d0f330bd3
Deleted: 6d350890881d7b7dfe0cb39f6ddca467ff93940c6bad4a5676d3bc50c8cb9073
Deleted: 2ff4a0781cb3b30748dd124acb695411773f57ecd16d845af4f6f339a64df1fc
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
