======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> ad9c9bcc353
STEP 3/23: ARG BOOTSTRAP=true
--> a546edc6f0d
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 87736fd4b29
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 26044fbac0d
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> b0e95278a33
STEP 7/23: ARG ALLOWED_TAGS=""
--> 088943b4e34
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 56686816b0d
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 286b3df120b
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> a73df39b2c3
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64                       
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64             
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.x86_64                
Installed:
  containers-common-2:1-35.module+el8.6.0+15917+093ca6f8.x86_64                 
  criu-3.15-3.module+el8.6.0+15875+dc9a2b96.x86_64                              
  fuse-common-3.3.0-15.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.6.0+15917+093ca6f8.x86_64                     
  fuse3-3.3.0-15.el8.x86_64                                                     
  fuse3-libs-3.3.0-15.el8.x86_64                                                
  iptables-libs-1.8.4-22.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-37.2-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.6.0+15875+dc9a2b96.x86_64                         
  nftables-1:0.9.3-25.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.3-2.module+el8.6.0+15917+093ca6f8.x86_64                           
  skopeo-2:1.8.0-2.module+el8.6.0+15917+093ca6f8.x86_64                         
  slirp4netns-1.2.0-2.module+el8.6.0+15917+093ca6f8.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Installing collected packages: xmltodict, argcomplete, toml, PyYAML, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> fb2322ec5d3
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 4115df37247
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 871730e3944
STEP 14/23: COPY ./VERSION /
--> af06463db37
STEP 15/23: COPY ./devfiles /build/devfiles
--> 6776e7140b2
STEP 16/23: WORKDIR /build/
--> 3a19d1dc8fa
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 121 packages from 182 contributors and audited 121 packages in 10.38s

4 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 240 packages in 2.54s

4 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 03d684dc133
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> e9a56050750
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + quay.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/jboss-eap-7/eap74-openjdk11-openshift-rhel8:7.4.4 PASS
 = registry.redhat.io/jboss-eap-7/eap-xp3-openjdk11-openshift-rhel8:3.0 PASS
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 0766ace53fd
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/00_java11-maven-eap/meta.yaml'
Checking devfile 'devfiles/00_java11-maven-microprofile-xp3/meta.yaml'
Checking devfile 'devfiles/03_camelk/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
Checking devfile 'devfiles/05_php-di/meta.yaml'
--> 051c5fd952f
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 53f89553268
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 6aebcb770a9
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> d7395213e1b
Successfully tagged localhost/devfileregistry:tmp
d7395213e1b7f04dec799a7b7aa0f29be1d3b5eb87aa248f7352843ae9fd672c
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
Binary files /tmp/tmp.VtEuyAN3tK/resources/v2/demo.zip and /tmp/tmp.rRfolVf2AI/resources/v2/demo.zip differ
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: d7395213e1b7f04dec799a7b7aa0f29be1d3b5eb87aa248f7352843ae9fd672c
Deleted: 6aebcb770a92ba3da84cfb9d32b965204c7aacb31e32aa1ccfdd12407fee354f
Deleted: 53f8955326840c5220080cf097f18c557d0a0f3aa665d90aae9ee760db283a3e
Deleted: 051c5fd952f6573e6cef6e5f6fa95df8a9008436f7bcb5e6bc448e62d5762f1f
Deleted: 0766ace53fdb91a8124ff6d3a375fd732dc4a634764e467ba77c752a13a5d266
Deleted: e9a56050750516e17111a2fe63718d5a6c67212cd3498d2c2724da93e480cbbf
Deleted: 03d684dc133c5cf2b5a76b0ca6650373554dda127e23d10625b297cda27969b7
Deleted: 3a19d1dc8fad789db6e1ef79271b476643611e4066fb25f7b955428da60b0903
Deleted: 6776e7140b29ec0354bc7eaa8f540deb91305ecaa2cab5120b5defe6f6d44e48
Deleted: af06463db37d905593c6a2daeb8ae37fa4ece889a093e9500f37243096fd0dda
Deleted: 871730e3944d758b102d470c9e5a8f77e0e6e77ec62ef65bb4d3fbcd0f64dbac
Deleted: 4115df37247309c6a841cc21cb7f721bd709a10ab74560782e444c24cd55ef24
Deleted: fb2322ec5d34b61d687788cbf21971539d0608c4e13d773ff803d7a221720c5a
Deleted: a73df39b2c3a7e450a7eec84a048a389b22a37288fc60135da5c549eafad479b
Deleted: 286b3df120bb9253a1fb166d20a166a4caec071fe1c0a4bded74f32e0ae3bf4a
Deleted: 56686816b0dcdc1e0af1de69c018125866ffac595ae7e8871eb44c3b2b2e0804
Deleted: 088943b4e3447c7a4f005149e9f68961a9f71207e1c35d86791ae7a99a58e90c
Deleted: b0e95278a33cfb029e107175a3adc56ef320aa1b73e49b99e1954962b9736c17
Deleted: 26044fbac0dac36162387491be241c1446ce10927fd5415c0ec934995573d919
Deleted: 87736fd4b2984a309cd01f634b2f71df8a9755851ef5f974aa0f1e40995e991d
Deleted: a546edc6f0dbb8ad9bc8f2f3ac851e914cccb03465990f3f08a2377e0b12f5c2
Deleted: ad9c9bcc3539a078f7a46ee1d79aeaa758f153aea27521369b41e976b9a07c1c
File already uploaded: root-local.tgz
Uploading: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
