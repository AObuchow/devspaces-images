======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 63af4ce4a49
STEP 3/23: ARG BOOTSTRAP=true
--> 59d8a35da2d
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 2f5fe34f59c
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> ceba00fb8c2
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 5901bd6864a
STEP 7/23: ARG ALLOWED_TAGS=""
--> ed55944bffc
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 128b57f47bd
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> b5510b4ad57
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> e1daa3be4e3
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64                       
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64             
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.x86_64                
Installed:
  containers-common-2:1-35.module+el8.6.0+15917+093ca6f8.x86_64                 
  criu-3.15-3.module+el8.6.0+15875+dc9a2b96.x86_64                              
  fuse-common-3.3.0-15.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.6.0+15917+093ca6f8.x86_64                     
  fuse3-3.3.0-15.el8.x86_64                                                     
  fuse3-libs-3.3.0-15.el8.x86_64                                                
  iptables-libs-1.8.4-22.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-37.2-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.6.0+15875+dc9a2b96.x86_64                         
  nftables-1:0.9.3-25.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.3-2.module+el8.6.0+15917+093ca6f8.x86_64                           
  skopeo-2:1.8.0-2.module+el8.6.0+15917+093ca6f8.x86_64                         
  slirp4netns-1.2.0-2.module+el8.6.0+15917+093ca6f8.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Installing collected packages: toml, PyYAML, argcomplete, xmltodict, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> f0ffce3a109
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 02e3cc9d573
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 5c1b69aa080
STEP 14/23: COPY ./VERSION /
--> 1a9e2569d51
STEP 15/23: COPY ./devfiles /build/devfiles
--> 51975cc6b28
STEP 16/23: WORKDIR /build/
--> 0f017a8b4a8
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 121 packages from 182 contributors and audited 121 packages in 16.75s

4 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 240 packages in 4.641s

4 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> e6386a7033a
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 2d337b6ff1a
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + quay.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/jboss-eap-7/eap74-openjdk11-openshift-rhel8:7.4.4 PASS
 = registry.redhat.io/jboss-eap-7/eap-xp3-openjdk11-openshift-rhel8:3.0 PASS
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> eb3b23e8077
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/00_java11-maven-eap/meta.yaml'
Checking devfile 'devfiles/00_java11-maven-microprofile-xp3/meta.yaml'
Checking devfile 'devfiles/03_camelk/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
Checking devfile 'devfiles/05_php-di/meta.yaml'
--> 7e3be241d6e
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> c1df2678a2e
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 881b603b827
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 8f9a2e8e42f
Successfully tagged localhost/devfileregistry:tmp
8f9a2e8e42f9752365ee3c044b3e45e2e2a08fd12991168640f76f262348345c
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
Binary files /tmp/tmp.W7qeVxADMI/resources/v2/cakephp-ex.zip and /tmp/tmp.AF5ZMoMQ5S/resources/v2/cakephp-ex.zip differ
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 8f9a2e8e42f9752365ee3c044b3e45e2e2a08fd12991168640f76f262348345c
Deleted: 881b603b827e0a8e22fda749ebbd0055e7e22c081bbf60c92999a1377fdf10af
Deleted: c1df2678a2e102c3a700baf9211a812cf234682ff705ed83c7b0044cd8d281dd
Deleted: 7e3be241d6e8e914c4e155a9327f048ead092234d86dd6b6fe92d5146611b9a3
Deleted: eb3b23e80775e6cb9b7ea2160ae79747bd8ee95afa242fd33f0bcddfd776709a
Deleted: 2d337b6ff1ada808ea2f85344342db6c8368698f76c675b05aae76b073359173
Deleted: e6386a7033ab18b05380d57511c1e384bb2aad6d1d9848e286090594ad8a9c6d
Deleted: 0f017a8b4a82fcab245f4e46a554c92979d0d8e4e31a2971f26ec6fcf1f91f22
Deleted: 51975cc6b288226fc8db92cae7049d0562c383758a7241b96c59caa41915b648
Deleted: 1a9e2569d51795c302f25272294074bd7f59ffd23007074e1fc4d71ac80bb788
Deleted: 5c1b69aa080781ff1140398df8cbd5a45a3b13839050fd91de0dfff36700fabc
Deleted: 02e3cc9d57334114d47c118f56f0106ad57107cfe151ff90197cd911013bb7d7
Deleted: f0ffce3a109ff0981c6408651674a8d67659849e030add238fe19b672e46d942
Deleted: e1daa3be4e377cb72abf2caf649f151d253d69cc5f576c8f35808da04a7d9156
Deleted: b5510b4ad57cf966f01470a9fdd67de7e63e831e8e3459f84b9dbac9049ae368
Deleted: 128b57f47bd5e766eddd280ce783b83948f6de7233d9b9d106adeb570e07a84b
Deleted: ed55944bffcf0e3a7fd91e5bc868a958d377c76cc13cb2c4b7d58cf77518f5dd
Deleted: 5901bd6864acd32589323332dc5d19905a5dc876a79a44038b4234d81b4ecb4a
Deleted: ceba00fb8c2424b0bce8147ccf3558ca43ea4b49f93d9b70ce04ce40936675df
Deleted: 2f5fe34f59ca07446a0030c963a98e7498037f04b438a1520b7dfa146e063f88
Deleted: 59d8a35da2d5df8827280996f0805b008e3487c1e2f2163af1c4e9ff2f6aa844
Deleted: 63af4ce4a4999287044c2130cda9952d6e5c054ec8c09325c37b5787cd4b5af3
File already uploaded: root-local.tgz
Uploading: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
