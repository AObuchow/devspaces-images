======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> b4542a8f37d
STEP 3/23: ARG BOOTSTRAP=true
--> b18baf89c49
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 37ff7aa14f1
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 22991eb326c
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 312f2ba5b1d
STEP 7/23: ARG ALLOWED_TAGS=""
--> f68cf4fcd03
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> ff022ccaedd
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> e884ffcea41
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 58924d47ab3
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64                       
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64             
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.x86_64                
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.x86_64                 
  criu-3.15-3.module+el8.6.0+16771+28dfca77.x86_64                              
  fuse-common-3.3.0-15.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.x86_64                     
  fuse3-3.3.0-15.el8.x86_64                                                     
  fuse3-libs-3.3.0-15.el8.x86_64                                                
  iptables-libs-1.8.4-22.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-37.2-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.x86_64                         
  nftables-1:0.9.3-25.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.3-2.module+el8.6.0+16771+28dfca77.x86_64                           
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.x86_64                         
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Installing collected packages: PyYAML, xmltodict, argcomplete, toml, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 36907e6f518
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 02999855e19
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 2605de54288
STEP 14/23: COPY ./VERSION /
--> a252291d962
STEP 15/23: COPY ./devfiles /build/devfiles
--> 97b3ccc6b07
STEP 16/23: WORKDIR /build/
--> 4a4e5d28902
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 20.173s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 3.407s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> f6728eaa5e8
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 0a47e7429dd
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + quay.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + quay.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> ec879aa85d3
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 772db82bdc0
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 207d4bd4870
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> d6fa9a8329f
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> d5171d24700
Successfully tagged localhost/devfileregistry:tmp
d5171d247007e267a37e0cb8bec7bb4b35cc8c3595f079cb0836803ddb9dff3e
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: d5171d247007e267a37e0cb8bec7bb4b35cc8c3595f079cb0836803ddb9dff3e
Deleted: d6fa9a8329f6c42bbb518f8a2716b88eb1b22f069b7e7f2f3a50c8a87c0e0df8
Deleted: 207d4bd48701746b56ebba97659b960c69c9193f8c99cb06cfdb987aff2a8258
Deleted: 772db82bdc0ff7b7d98d224e615203b8dcee07a914f0493d06a9b92934ec42d4
Deleted: ec879aa85d31cacd58612cf6d2805415ad97bbb634aa100de9e87c790fe82e96
Deleted: 0a47e7429dd67810e610787ff1d061b70849d0ec08334feb962782336c58f1c4
Deleted: f6728eaa5e8f69bde57ac90e33e65205ac8c10b713dd969e280dad69c0f15b11
Deleted: 4a4e5d289025f375de3a2fc3d1d393f1e542e79fe914379ba82a9e508318d739
Deleted: 97b3ccc6b071abdfe6d1f7964c8d453372b0401a0c135cb7be7b33045433ed1f
Deleted: a252291d962d32d7f8cac6acc88084e2ccec210b1a5f4b1cefa4f948f5577835
Deleted: 2605de5428823eca0dfedafa472d53f30522187b9d271c94f5f2f84b06495446
Deleted: 02999855e1981acbb8bb810835ae98c2d9d085ef936f713f999f606eca4efb6a
Deleted: 36907e6f518f8d1f1d5d6c3656a3ec31609abb051239237d74823a1af7b32080
Deleted: 58924d47ab3d45b2b1323240451607cabf577a29708739df4f26f5e5229d2374
Deleted: e884ffcea416ea55eda4a95ef5a3cd55c53d2db3b0efc0b6bfdc89dfa3358adc
Deleted: ff022ccaedd74113a172dd09cc58e5a88bf197c6255014561ecf41e552eddb34
Deleted: f68cf4fcd039ad9b742cc4cc7f4b71001fba4d5d240cd6de5d53984d1750db2b
Deleted: 312f2ba5b1d6893d85c98105a041035e66f98b673b8383590c4122ad1c290e3b
Deleted: 22991eb326cfe9a8d60fcef6729984e3e8bdb66ce4dc2e77a957d73ea668c3d8
Deleted: 37ff7aa14f16ec975b474d985d0dd2bcaf0daef77e7d3eb39970e11756f69ea2
Deleted: b18baf89c49f0dbf983d9e22154930f6a172b1c0a44e53b05c0292ae9681cd9e
Deleted: b4542a8f37d2b3374ddc026225d54b6ff69af3f1083087c773149704f2cfd600
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
