======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 59739b508bc
STEP 3/23: ARG BOOTSTRAP=true
--> 9494deee357
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 26d5e0f15b5
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> df9c1e57c0a
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 01aed894800
STEP 7/23: ARG ALLOWED_TAGS=""
--> 24220c458dc
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> be3a4330560
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 3813a619b97
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 662bee9e092
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=e2a9c212f9a0f86c220e1fb7a6f7fff431176e91b9cf6bfde592fe9b20b94a40
  Stored in directory: /tmp/pip-ephem-wheel-cache-j36vee7q/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: argcomplete, xmltodict, PyYAML, toml, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 4d487909707
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> fc6fdcc5a76
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> e0e96f0cae6
STEP 14/23: COPY ./VERSION /
--> c0be2135c3a
STEP 15/23: COPY ./devfiles /build/devfiles
--> f56121a7320
STEP 16/23: WORKDIR /build/
--> 570d21fef28
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 10.329s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.948s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 95ea7c885ee
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 39f7a61fe82
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 3860a888628
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 8d417690ae5
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 08e2a5816e9
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 8678bb6701f
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 7d03ab440f4
Successfully tagged localhost/devfileregistry:tmp
7d03ab440f498e818aab16ab9ffee086473bc4e66bc743262a0ada41efca9c93
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/cakephp-ex.zip and /tmp/tmp.xsJRljxlJB/resources/v2/cakephp-ex.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/c-plus-plus.zip and /tmp/tmp.xsJRljxlJB/resources/v2/c-plus-plus.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/golang-health-check.zip and /tmp/tmp.xsJRljxlJB/resources/v2/golang-health-check.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/gs-validating-form-input.zip and /tmp/tmp.xsJRljxlJB/resources/v2/gs-validating-form-input.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/lombok-project-sample.zip and /tmp/tmp.xsJRljxlJB/resources/v2/lombok-project-sample.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/nodejs-mongodb-sample.zip and /tmp/tmp.xsJRljxlJB/resources/v2/nodejs-mongodb-sample.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/python-hello-world.zip and /tmp/tmp.xsJRljxlJB/resources/v2/python-hello-world.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/quarkus-quickstarts.zip and /tmp/tmp.xsJRljxlJB/resources/v2/quarkus-quickstarts.zip differ
Binary files /tmp/tmp.goqa0mxuBa/resources/v2/web-nodejs-sample.zip and /tmp/tmp.xsJRljxlJB/resources/v2/web-nodejs-sample.zip differ
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 7d03ab440f498e818aab16ab9ffee086473bc4e66bc743262a0ada41efca9c93
Deleted: 8678bb6701f5dc089e0e1ecb7c959b0e90ea25772ddcfdd7e4e502e9d630fa07
Deleted: 08e2a5816e99fd7ec9d4b449f296539db0546cb3dafafa4281fec51bf16f8ca8
Deleted: 8d417690ae5d825eecbba2a874b9a8cf719ad249586e5bf314b52d98c6928e3c
Deleted: 3860a88862897e3d8a76470751b102dd4aa0fddb4b436722a1b5b40dc9a17986
Deleted: 39f7a61fe822c6cd40e7de1fdd9ed977800e55f1be58fbc61c018742ad758adf
Deleted: 95ea7c885ee3e9afc4a4f9a72c62b20cc37e165eb3ed54cf5fac3025d0f9ac3a
Deleted: 570d21fef28ebddf8bb52984a6f4fc4e1051ec8102e81b25e30878194aa078cc
Deleted: f56121a732043898a2f209f2da7456ae6c36a338d82625e38e9396592bab9cfd
Deleted: c0be2135c3a5b66f86ff96a217aedf8c0cd3fd3f9b30a620b5d361dcbc126425
Deleted: e0e96f0cae6d06630c29934e9b2c50cdb7841ac037a8eb4f1bd26bbd7d6e5f72
Deleted: fc6fdcc5a768eaf3296d5e118019ec7641af14f4ca7230ce8a9744fe10f22227
Deleted: 4d487909707d0d05805112fdf94c6f51fb60259f3aebd2380a8fcc2d2440a877
Deleted: 662bee9e09293755a6f4956bfaf18f7b67f0e03df900faa57bfff4ea402db0a3
Deleted: 3813a619b97d6a7085301dd8eb33f9c284b901846139bb90881163dc59038aa5
Deleted: be3a4330560812f93299cc63544a06d13b179fa8d6f02e6e5cf4c0d20264accd
Deleted: 24220c458dce0788bf78a355341ce1af23612fc722025deecd9e0d8e160127ad
Deleted: 01aed894800a4982049564657d22262f6c0896fd2de3eeee3e65dad40ec924d3
Deleted: df9c1e57c0aec8a44bbeada4c216242f5b531292924c43a6cb75b14530443a34
Deleted: 26d5e0f15b573346109392f090a624255366cc4165b50202e8acdadba566de30
Deleted: 9494deee357f15e5b63f3cba87390d0e2b22e29add3895af9478a98d101727da
Deleted: 59739b508bcca1c75a980d4f5d95cc0cd73011f437e9b77773e6b891c82030a5
File already uploaded: root-local.tgz
Uploading: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
