======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 20258a4a37b
STEP 3/23: ARG BOOTSTRAP=true
--> 0b8765b0319
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 6fc7f2da433
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 58542a10170
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 3e656376840
STEP 7/23: ARG ALLOWED_TAGS=""
--> 516269a336b
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 6f0f5f09479
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 4afada7fd3e
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> b5b3ea31386
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=445d11f5faafaa706d52efec2c371cd1dc5278a9eb2c541bcc339dc858452af1
  Stored in directory: /tmp/pip-ephem-wheel-cache-_ht5cyoa/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: argcomplete, PyYAML, xmltodict, toml, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 40e4953ab89
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 16c97cda9dc
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 8eec625ac53
STEP 14/23: COPY ./VERSION /
--> 4e44f7e0e18
STEP 15/23: COPY ./devfiles /build/devfiles
--> 976b2f5a80d
STEP 16/23: WORKDIR /build/
--> e267a3fab96
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 11.884s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.548s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 2017328d70a
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> a6839efb742
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> dd6ccad91f5
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> b4c0670e637
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 7845a079e5d
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> b10a19c8329
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> fef6233eb6a
Successfully tagged localhost/devfileregistry:tmp
fef6233eb6af0a0e920102d7ba284c1f7716445f4841776d893bfeeea29dbd05
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: fef6233eb6af0a0e920102d7ba284c1f7716445f4841776d893bfeeea29dbd05
Deleted: b10a19c8329e96edd85bb6d9f6da91043cc59323157f53694b58648babec6943
Deleted: 7845a079e5dcba6154df38586f4739ba1e659a98be62b172c3824f5ab6d0c69e
Deleted: b4c0670e637dae028ecbc0006c1234246e4480f9ddee2ca9411475a0e9d8be9b
Deleted: dd6ccad91f538210ac74b1e49364402e663c68cb18f6662cc155d7480f1141ba
Deleted: a6839efb7426b43bc5d45a9f16af77c48c4c609765b9efc2ccd83bd544827d27
Deleted: 2017328d70abc130a188e5825ba202ee9de3bcf274616c8e9c7534aa333ab0c6
Deleted: e267a3fab9652c68d992a08472eaa656c5046cc15ec21735a1437d7c64028d96
Deleted: 976b2f5a80df991de1c6f95754b3b5bf894c60a5c972b285b4fc5973fbb0c86f
Deleted: 4e44f7e0e188e0b937c17a7703395061f4561345ca1012228ae3c7f7ded0b2be
Deleted: 8eec625ac53239bdefdf896da43ad7b18779a3f911e3a1be474cf7f9b29da712
Deleted: 16c97cda9dcad80e4ba6c9ff74f05709de933e5f6ed652540ab71c8e035d1022
Deleted: 40e4953ab890d42e141a1997b0354ea50f46b1df720430858362f705f7acdcea
Deleted: b5b3ea31386bfb6308a9904461432a736660e4f0c21ff6bf7789ecb4cc43948e
Deleted: 4afada7fd3eee219ddbe49711be85ee8ec3bac40ad5b17e6bde9bc988bcda21c
Deleted: 6f0f5f09479e8eb3b5fd5d290ab0c0535f1fc86c6d560af811e6ed22fa6f140b
Deleted: 516269a336b20db3168a8e5053388b2f3374c3308d7b87cbe659ad76370627ea
Deleted: 3e6563768407c9fcdcda3a67c723cfcc32eeceff7640e15e8b521d8927675094
Deleted: 58542a10170171daec53b10e9e0cca9f1195300f9ad66116b33337337a54b267
Deleted: 6fc7f2da4332d8ea0a1fe5337a7271407ff3e6c78d43cae300e57706b9dcc5c5
Deleted: 0b8765b03192e58b16cd6327d5ef42d4d37aa8b6387952ac88c3235e6e0a1edd
Deleted: 20258a4a37bc324caa19c6d85015b8de45c53054d188a667faf1c9d40ab03aeb
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
