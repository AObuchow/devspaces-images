======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> bda55a38a2c
STEP 3/23: ARG BOOTSTRAP=true
--> 14a483e975b
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 481d1878b1b
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> f1185b1c167
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> f4395ea8799
STEP 7/23: ARG ALLOWED_TAGS=""
--> 02da0b2d551
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 63d8c92034c
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 0683e1bcd16
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 12350f588f2
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64                       
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64             
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.x86_64                
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.x86_64                 
  criu-3.15-3.module+el8.6.0+16771+28dfca77.x86_64                              
  fuse-common-3.3.0-15.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.x86_64                     
  fuse3-3.3.0-15.el8.x86_64                                                     
  fuse3-libs-3.3.0-15.el8.x86_64                                                
  iptables-libs-1.8.4-22.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-37.2-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.x86_64                         
  nftables-1:0.9.3-25.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.x86_64                           
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.x86_64                         
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Installing collected packages: PyYAML, xmltodict, toml, argcomplete, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> d37e8e0b1fc
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> add83ac5809
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 98d66da494f
STEP 14/23: COPY ./VERSION /
--> 4f8e883290e
STEP 15/23: COPY ./devfiles /build/devfiles
--> 6bf4489d996
STEP 16/23: WORKDIR /build/
--> 6a79c9a411e
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 8.723s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 1.923s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> b39a5dadc1a
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 7cf2ce1706c
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> e7aa45652f4
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> ef7cb3ff5db
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 777eb0878b2
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 72c4ebe8520
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> d24975e18cd
Successfully tagged localhost/devfileregistry:tmp
d24975e18cd964dace810e80f7ba4bcf8c8468c9dc958b73fe043fc90bd7919e
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.43mvzCJqXw/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA /tmp/tmp.cIhwjcnFTF/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA
--- /tmp/tmp.43mvzCJqXw/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-10-31 11:34:26.000000000 -0400
+++ /tmp/tmp.cIhwjcnFTF/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-11-01 14:31:37.534554426 -0400
@@ -3,10 +3,10 @@
 Version: 6.0
 Summary: YAML parser and emitter for Python
 Home-page: https://pyyaml.org/
-Download-URL: https://pypi.org/project/PyYAML/
 Author: Kirill Simonov
 Author-email: xi@resolvent.net
 License: MIT
+Download-URL: https://pypi.org/project/PyYAML/
 Project-URL: Bug Tracker, https://github.com/yaml/pyyaml/issues
 Project-URL: CI, https://github.com/yaml/pyyaml/actions
 Project-URL: Documentation, https://pyyaml.org/wiki/PyYAMLDocumentation
@@ -43,3 +43,4 @@
 
 PyYAML is applicable for a broad range of tasks from complex
 configuration files to object serialization and persistence.
+
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.43mvzCJqXw/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD /tmp/tmp.cIhwjcnFTF/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD
--- /tmp/tmp.43mvzCJqXw/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-10-31 11:34:26.000000000 -0400
+++ /tmp/tmp.cIhwjcnFTF/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-01 14:31:37.534554426 -0400
@@ -1,8 +1,8 @@
 PyYAML-6.0.dist-info/INSTALLER,sha256=zuuue4knoyJ-UwPPXg8fezS7VCrXJQrAP7zeNuwvFQg,4
 PyYAML-6.0.dist-info/LICENSE,sha256=jTko-dxEkP1jVwfLiOsmvXZBAqcoKVQwfT5RZ6V36KQ,1101
-PyYAML-6.0.dist-info/METADATA,sha256=Q56A1jQxEnzMMCyqgYkqM5Egvr9y18VExGF3ciGLjlY,2005
+PyYAML-6.0.dist-info/METADATA,sha256=QmHx9kGp_0yezQCXYaft4eEFeJ6W4oyFfYwHDLP1kdg,2006
 PyYAML-6.0.dist-info/RECORD,,
-PyYAML-6.0.dist-info/WHEEL,sha256=VXb7H8_fWiBJHbEvxuDSYbC9VxfKWz2_woH0TyHF8yQ,104
+PyYAML-6.0.dist-info/WHEEL,sha256=RiwktpmF40OphKd3_aIG01PzIOQlJ7dpBn3cFSc9vak,217
 PyYAML-6.0.dist-info/top_level.txt,sha256=rpj0IVMTisAjh_1vG3Ccf9v5jpCQwAz6cD1IVU5ZdhQ,11
 _yaml/__init__.py,sha256=04Ae_5osxahpJHa3XBZUAf4wi6XX32gR8D6X6p64GEA,1402
 _yaml/__pycache__/__init__.cpython-38.pyc,,
@@ -24,6 +24,7 @@
 yaml/__pycache__/scanner.cpython-38.pyc,,
 yaml/__pycache__/serializer.cpython-38.pyc,,
 yaml/__pycache__/tokens.cpython-38.pyc,,
+yaml/_yaml.cpython-38-x86_64-linux-gnu.so,sha256=lMaKSmQZy3WNZSmmU0Wg5Y5ZAs-HR5vItyGVUIsp8Rg,2847784
 yaml/composer.py,sha256=_Ko30Wr6eDWUeUpauUGT3Lcg9QPBnOPVlTnIMRGJ9FM,4883
 yaml/constructor.py,sha256=kNgkfaeLUkwQYY_Q6Ff1Tz2XVw_pG1xVE9Ak7z-viLA,28639
 yaml/cyaml.py,sha256=6ZrAG9fAYvdVe2FK_w0hmXoG7ZYsoYUwapG8CiC72H0,3851
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.43mvzCJqXw/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL /tmp/tmp.cIhwjcnFTF/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL
--- /tmp/tmp.43mvzCJqXw/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-10-31 11:34:26.000000000 -0400
+++ /tmp/tmp.cIhwjcnFTF/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-01 14:31:37.534554426 -0400
@@ -1,5 +1,8 @@
 Wheel-Version: 1.0
-Generator: bdist_wheel (0.37.1)
+Generator: bdist_wheel (0.37.0)
 Root-Is-Purelib: false
-Tag: cp38-cp38-linux_ppc64le
+Tag: cp38-cp38-manylinux_2_5_x86_64
+Tag: cp38-cp38-manylinux1_x86_64
+Tag: cp38-cp38-manylinux_2_12_x86_64
+Tag: cp38-cp38-manylinux2010_x86_64
 
Only in /tmp/tmp.cIhwjcnFTF/lib/python3.8/site-packages/yaml: _yaml.cpython-38-x86_64-linux-gnu.so
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: d24975e18cd964dace810e80f7ba4bcf8c8468c9dc958b73fe043fc90bd7919e
Deleted: 72c4ebe852069b9a8fb8b4bbbdb80afab7a4d88a33f42fd608c2a45d42a6a148
Deleted: 777eb0878b26fefa4e0f85c1f10bf0e467a27bc901c79356fb808f3255474c7b
Deleted: ef7cb3ff5db1f1c8bf24a6bf85d48ea11852213a94bd7c0def130753a43e7534
Deleted: e7aa45652f456ce196a88cbab2d72f6820502ececadadd85ab033cfdfbdef37d
Deleted: 7cf2ce1706c2c22fc1a72e8146f2c410fb6978e932cafd7e7bd70906c481c9ee
Deleted: b39a5dadc1af04cca2bcfcfe59e10e9a093c589e607d7cfa3eeb5ea2d86e9ec8
Deleted: 6a79c9a411ebb339cb37adc53d8b81744d19b4637d7ae53e43c604bab08d111d
Deleted: 6bf4489d996218f75bc78394405322b1483476dd0388bcf852cfd26d2e614c2c
Deleted: 4f8e883290e9cc0bd3ddacaf619dd78dd4200372798c507bc04daff39b95683b
Deleted: 98d66da494f4f73ad0a8acb1eab43e76ba5a3de2682818d3b9d4e903a03fe6cb
Deleted: add83ac58091a6cd4f28395c1c34f36abd44898d1ba3b3659884cd18bd7f219c
Deleted: d37e8e0b1fcf3c0b1f3fb7256c946bb85078216b4ee3b4a1830187b4edf3122b
Deleted: 12350f588f25ea620fdd05a005045b88420a82e7b6b6e20434c9ea9049850bf8
Deleted: 0683e1bcd16ce1698410140b8452197940e259136f9750c98c511ec83d8fd85c
Deleted: 63d8c92034c996db873436e90b7ce88c7f1c2ee960d50361af51fc9318371567
Deleted: 02da0b2d55108adff2b5d8639c8a78625320a02861b8b9b4a40df6f538a2e536
Deleted: f4395ea8799e747364aeb5e1ece71771fbacfaed037a37fb3fb8d722c706bea1
Deleted: f1185b1c167ed38da76c5e7a56d101ed73b7754d08f078ac181ac2b68f739203
Deleted: 481d1878b1b8652e4291c22229abaac2d8e2decbc2cd79390a7edc522f60d627
Deleted: 14a483e975bceb85452c2a3888fd88ab309b159ebada523640f84e89ff2841ee
Deleted: bda55a38a2c9b43a0683364ee725660474c430e63f952c12bbf8a9f65c1bd7ba
Uploading: root-local.tgz
File already uploaded: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
