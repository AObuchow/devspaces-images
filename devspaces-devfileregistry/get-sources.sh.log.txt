======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 3a331373b0b
STEP 3/23: ARG BOOTSTRAP=true
--> 753f5b17f32
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 93d9cf903e6
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> f7579003621
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> ba441d7ce3f
STEP 7/23: ARG ALLOWED_TAGS=""
--> 7e29f31d187
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 592e36b184c
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 1400dd15d84
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> dec24b8c1d4
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  dnf-4.7.0-11.el8.noarch                                                       
  dnf-data-4.7.0-11.el8.noarch                                                  
  nodejs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le                      
  nodejs-docs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.noarch                  
  nodejs-full-i18n-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le            
  npm-1:6.14.17-1.14.20.1.2.module+el8.7.0+16991+b0a68a3e.ppc64le               
  python3-dnf-4.7.0-11.el8.noarch                                               
  python38-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                       
  python38-devel-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                 
  python38-libs-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                  
  python38-pip-19.3.1-6.module+el8.7.0+15823+8950cfa7.noarch                    
  tar-2:1.30-6.el8.ppc64le                                                      
  yum-4.7.0-11.el8.noarch                                                       
Installed:
  containers-common-2:1-43.module+el8.7.0+17064+3b31f55c.ppc64le                
  criu-3.15-3.module+el8.7.0+17064+3b31f55c.ppc64le                             
  fuse-common-3.3.0-16.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.7.0+17064+3b31f55c.ppc64le                    
  fuse3-3.3.0-16.el8.ppc64le                                                    
  fuse3-libs-3.3.0-16.el8.ppc64le                                               
  iptables-libs-1.8.4-23.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-41.0-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  nftables-1:0.9.3-26.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  rpm-plugin-systemd-inhibit-4.14.3-23.el8.ppc64le                              
  runc-1:1.1.4-1.module+el8.7.0+17064+3b31f55c.ppc64le                          
  skopeo-2:1.9.3-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.7.0+17064+3b31f55c.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=1f4cf94c8444b10405db35ba1dff5abb06719b9c3f2a12305fb7b23db5276ac7
  Stored in directory: /tmp/pip-ephem-wheel-cache-28mop2oo/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: xmltodict, argcomplete, PyYAML, toml, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.13
yq: yq 3.1.0
jq: jq-1.6
--> 93ca56de70c
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 306767f442a
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 4f07ff65788
STEP 14/23: COPY ./VERSION /
--> b8dc048a791
STEP 15/23: COPY ./devfiles /build/devfiles
--> 584a09bb54f
STEP 16/23: WORKDIR /build/
--> 18bd69ace97
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 10.451s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 3.086s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> b800e5c280e
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 9926c4bec64
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - 3.4 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 4cb3a9114dd
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_dotnet/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 52d6900f16f
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 870744960b4
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 80e6e17d6bd
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 4827e54d9cb
Successfully tagged localhost/devfileregistry:tmp
4827e54d9cb4ff4176ca139256c0437239be31b2bc15270d8a1e7c5584761187
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
Binary files /tmp/tmp.qMVvSFDe6G/resources/v2/python-hello-world.zip and /tmp/tmp.7jiKh9tsxi/resources/v2/python-hello-world.zip differ
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 4827e54d9cb4ff4176ca139256c0437239be31b2bc15270d8a1e7c5584761187
Deleted: 80e6e17d6bd7e46a7fb79d7f8fe36f6f9067a8eb23252f2bbe24e7df9f1668cd
Deleted: 870744960b43c6c79b232fccc0e5b4edbe8b2c413e20a6bb36f4c8a3edf6f8e1
Deleted: 52d6900f16fff383570459502174786ad266c6a08dc6824f3572533523ebf5c2
Deleted: 4cb3a9114dd63d6858bc7bdf47bbc353d94a3795479ab4bcce7c37c6727f9a85
Deleted: 9926c4bec64756e6a665707e377f958bc04fa5b42d1c060bc0184bcdc7c5e797
Deleted: b800e5c280e561c623073da01bd66d1e742f78224b866ff86a8641399cf0a924
Deleted: 18bd69ace975227eb005f6ea36dd9864f054c7138943be48608468595dee12b6
Deleted: 584a09bb54fd214b1a2e3bb6bdf8414aa087eae4e2cc5a4aaa6fab6e5cdf6363
Deleted: b8dc048a79133bd2666d1228059e3049a04eb53fc6578400a8a8e28b814f342f
Deleted: 4f07ff657883ec67f7b2306b97b6300c69b2b289287d4af73a94f7c9b0c8c97f
Deleted: 306767f442ac353eaf5bb2cec2112a2837c74b2d080751dc21a8c0a0598f9355
Deleted: 93ca56de70cc8d7ea57287ef433ce491bbb57b86a952afcbd75a13fd92c14bfa
Deleted: dec24b8c1d4ebd4fd83ca1528c6e73197501e9a091f36c91a8390e5cbab64264
Deleted: 1400dd15d84068a82fd603de0b8b09877d19bf838ca1090283b313fab9fdf13c
Deleted: 592e36b184c02d2c0d192b23b067ecb461fe4dbd015364a70a3a83919928345a
Deleted: 7e29f31d187fcdb0d05970f36b38340e733d63eca0638225243ab37e02fc6325
Deleted: ba441d7ce3f18b8249c5f89c723a3c1c67bec8b9056ed34a5da8b160c26d795e
Deleted: f7579003621b858a9123cc746b4e1f53e8c7630bee0a1a5b88b374addcb2dcdd
Deleted: 93d9cf903e62433b17821fc38238feb724c06e382a87097fcfd14e868b453ccf
Deleted: 753f5b17f32fc6c1fda204b1abeb4e2355336f4932fa2584e8d13150544f5d0d
Deleted: 3a331373b0b7278c8606228bdad3604b5c459e0af12f16158c13d4a6cad7fa52
File already uploaded: root-local.tgz
Uploading: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
