======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> c8a9e117af8
STEP 3/23: ARG BOOTSTRAP=true
--> 831909736cd
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 6df4165da3d
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 0d1d085bf8d
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> c54277fb27b
STEP 7/23: ARG ALLOWED_TAGS=""
--> 86b8400fb73
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 6afa12c54ba
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 7b4d7778c28
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 27af68fddc0
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  dnf-4.7.0-11.el8.noarch                                                       
  dnf-data-4.7.0-11.el8.noarch                                                  
  nodejs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le                      
  nodejs-docs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.noarch                  
  nodejs-full-i18n-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le            
  npm-1:6.14.17-1.14.20.1.2.module+el8.7.0+16991+b0a68a3e.ppc64le               
  python3-dnf-4.7.0-11.el8.noarch                                               
  python38-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                       
  python38-devel-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                 
  python38-libs-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                  
  python38-pip-19.3.1-6.module+el8.7.0+15823+8950cfa7.noarch                    
  tar-2:1.30-6.el8.ppc64le                                                      
  yum-4.7.0-11.el8.noarch                                                       
Installed:
  containers-common-2:1-43.module+el8.7.0+17064+3b31f55c.ppc64le                
  criu-3.15-3.module+el8.7.0+17064+3b31f55c.ppc64le                             
  fuse-common-3.3.0-16.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.7.0+17064+3b31f55c.ppc64le                    
  fuse3-3.3.0-16.el8.ppc64le                                                    
  fuse3-libs-3.3.0-16.el8.ppc64le                                               
  iptables-libs-1.8.4-23.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-41.0-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  nftables-1:0.9.3-26.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  rpm-plugin-systemd-inhibit-4.14.3-23.el8.ppc64le                              
  runc-1:1.1.4-1.module+el8.7.0+17064+3b31f55c.ppc64le                          
  skopeo-2:1.9.3-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.7.0+17064+3b31f55c.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=8a91165e8beaecec0b10b4131e46e2169ed1e945f778887827678736723e0414
  Stored in directory: /tmp/pip-ephem-wheel-cache-enjhzdvz/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: xmltodict, toml, argcomplete, PyYAML, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.13
yq: yq 3.1.0
jq: jq-1.6
--> 949fa50864d
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 3226864361a
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> b59cca0246f
STEP 14/23: COPY ./VERSION /
--> df71b05b935
STEP 15/23: COPY ./devfiles /build/devfiles
--> 90c4d105b77
STEP 16/23: WORKDIR /build/
--> 5d9120c3cc6
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 10.538s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.351s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 6885e01fc3e
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> a9ed71da70e
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - 3.4 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> f19a022b957
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> ce75f195f4f
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> fc5d3b532fe
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 46b0de7edb3
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> b86238329f7
Successfully tagged localhost/devfileregistry:tmp
b86238329f7b2c5b0b9bd471eacdba45eec343c6442ea7e972e5b4594a409bc3
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.dajP7J0TdN/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA /tmp/tmp.4RHK9w3DSG/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA
--- /tmp/tmp.dajP7J0TdN/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-11-10 03:00:03.000000000 +0000
+++ /tmp/tmp.4RHK9w3DSG/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-11-12 02:08:47.784486098 +0000
@@ -3,10 +3,10 @@
 Version: 6.0
 Summary: YAML parser and emitter for Python
 Home-page: https://pyyaml.org/
+Download-URL: https://pypi.org/project/PyYAML/
 Author: Kirill Simonov
 Author-email: xi@resolvent.net
 License: MIT
-Download-URL: https://pypi.org/project/PyYAML/
 Project-URL: Bug Tracker, https://github.com/yaml/pyyaml/issues
 Project-URL: CI, https://github.com/yaml/pyyaml/actions
 Project-URL: Documentation, https://pyyaml.org/wiki/PyYAMLDocumentation
@@ -43,4 +43,3 @@
 
 PyYAML is applicable for a broad range of tasks from complex
 configuration files to object serialization and persistence.
-
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.dajP7J0TdN/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD /tmp/tmp.4RHK9w3DSG/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD
--- /tmp/tmp.dajP7J0TdN/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-10 03:00:03.000000000 +0000
+++ /tmp/tmp.4RHK9w3DSG/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-12 02:08:47.784486098 +0000
@@ -1,8 +1,8 @@
 PyYAML-6.0.dist-info/INSTALLER,sha256=zuuue4knoyJ-UwPPXg8fezS7VCrXJQrAP7zeNuwvFQg,4
 PyYAML-6.0.dist-info/LICENSE,sha256=jTko-dxEkP1jVwfLiOsmvXZBAqcoKVQwfT5RZ6V36KQ,1101
-PyYAML-6.0.dist-info/METADATA,sha256=QmHx9kGp_0yezQCXYaft4eEFeJ6W4oyFfYwHDLP1kdg,2006
+PyYAML-6.0.dist-info/METADATA,sha256=Q56A1jQxEnzMMCyqgYkqM5Egvr9y18VExGF3ciGLjlY,2005
 PyYAML-6.0.dist-info/RECORD,,
-PyYAML-6.0.dist-info/WHEEL,sha256=RiwktpmF40OphKd3_aIG01PzIOQlJ7dpBn3cFSc9vak,217
+PyYAML-6.0.dist-info/WHEEL,sha256=f8vErwyDyFouYea3KNqXIy0we1lRdJObBl1MFdhTmU0,104
 PyYAML-6.0.dist-info/top_level.txt,sha256=rpj0IVMTisAjh_1vG3Ccf9v5jpCQwAz6cD1IVU5ZdhQ,11
 _yaml/__init__.py,sha256=04Ae_5osxahpJHa3XBZUAf4wi6XX32gR8D6X6p64GEA,1402
 _yaml/__pycache__/__init__.cpython-38.pyc,,
@@ -24,7 +24,6 @@
 yaml/__pycache__/scanner.cpython-38.pyc,,
 yaml/__pycache__/serializer.cpython-38.pyc,,
 yaml/__pycache__/tokens.cpython-38.pyc,,
-yaml/_yaml.cpython-38-x86_64-linux-gnu.so,sha256=lMaKSmQZy3WNZSmmU0Wg5Y5ZAs-HR5vItyGVUIsp8Rg,2847784
 yaml/composer.py,sha256=_Ko30Wr6eDWUeUpauUGT3Lcg9QPBnOPVlTnIMRGJ9FM,4883
 yaml/constructor.py,sha256=kNgkfaeLUkwQYY_Q6Ff1Tz2XVw_pG1xVE9Ak7z-viLA,28639
 yaml/cyaml.py,sha256=6ZrAG9fAYvdVe2FK_w0hmXoG7ZYsoYUwapG8CiC72H0,3851
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.dajP7J0TdN/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL /tmp/tmp.4RHK9w3DSG/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL
--- /tmp/tmp.dajP7J0TdN/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-10 03:00:03.000000000 +0000
+++ /tmp/tmp.4RHK9w3DSG/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-12 02:08:47.784486098 +0000
@@ -1,8 +1,5 @@
 Wheel-Version: 1.0
-Generator: bdist_wheel (0.37.0)
+Generator: bdist_wheel (0.38.4)
 Root-Is-Purelib: false
-Tag: cp38-cp38-manylinux_2_5_x86_64
-Tag: cp38-cp38-manylinux1_x86_64
-Tag: cp38-cp38-manylinux_2_12_x86_64
-Tag: cp38-cp38-manylinux2010_x86_64
+Tag: cp38-cp38-linux_ppc64le
 
Only in /tmp/tmp.dajP7J0TdN/lib/python3.8/site-packages/yaml: _yaml.cpython-38-x86_64-linux-gnu.so
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: b86238329f7b2c5b0b9bd471eacdba45eec343c6442ea7e972e5b4594a409bc3
Deleted: 46b0de7edb3529001c49d0fc1df7f50f5e4338bf196612818791f18d0ec48934
Deleted: fc5d3b532fe6f437d97c780fa8774c8b086073d0e9bd6d2bd3e10586d5416f9a
Deleted: ce75f195f4f71cc6666f8628ea3f9f66ac3f22970a71c8cce9db6e8e17e514b7
Deleted: f19a022b957349adf2f21d2ca9c697e756b2d88d6a741aeccac34f1a96117731
Deleted: a9ed71da70ec57bc0754c66342f674953e70b3f3cae94d6499cf9ea62dd2db60
Deleted: 6885e01fc3e05e92026560dde80c821c9ad750db6b7d112814b954680a1d3964
Deleted: 5d9120c3cc6edeabab05a2fbe271285de7e3b47b4c3d67ce962096c2db178483
Deleted: 90c4d105b77ff964baba9367148de4a715f8de63716289201811679e1d8bdfd0
Deleted: df71b05b9355b7cc0ce261e0192273c1b64f84bf15ea5471c00920b1934f3a40
Deleted: b59cca0246f68a9f704c9e421063169782b040a99bd45287b713f6957f15089f
Deleted: 3226864361af0c016c32d44fdf3828c6642074ba649004d413b2b5265b60e89e
Deleted: 949fa50864d38b3090c283a728c06a49253c350e6ac30abb6daa0693d30288c6
Deleted: 27af68fddc0e189b8640eeb08de896d04f0baf8b54000d0935ce58758578a4da
Deleted: 7b4d7778c28be7fe5682a89c0ebe83f1d2137085a375cc6bde179553f4c2ad8b
Deleted: 6afa12c54ba0c924160d7a25133032c22f8c1ad8f00db749ee457384f8eb439f
Deleted: 86b8400fb736a12456c291fe851d70f1a183cdd6a3c3e30853a127ede0bd5c13
Deleted: c54277fb27bea6fdb544a48428370d0b379a90f641bcf5d09b3665d331f7df9c
Deleted: 0d1d085bf8d3bf929a198c3ae4c560ddcb17645e5ed9a465bcdfca7f7db15550
Deleted: 6df4165da3dd19772b725a65aeae9d8991546911800f75e5f3c81ac42993c8c1
Deleted: 831909736cd32a1baf0fee1113a48ba6942b9de4f11cdfd1b715f56051403e06
Deleted: c8a9e117af8ffc7c7465cb1f7a42558f18d91d70655e6f7f7048a0d26d235d4a
Uploading: root-local.tgz
File already uploaded: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
