======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 90b3f8e7e97
STEP 3/23: ARG BOOTSTRAP=true
--> 2cfedfc2748
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> e4b5d4c3422
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> d00eb074a8e
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> fbaa88fa018
STEP 7/23: ARG ALLOWED_TAGS=""
--> dc21cc83d05
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> d0dbc63b1ea
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 82901f1953d
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> f71b6a9e056
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.x86_64                                                    
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64                       
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.x86_64             
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.x86_64                
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.x86_64                 
  criu-3.15-3.module+el8.6.0+16771+28dfca77.x86_64                              
  fuse-common-3.3.0-15.el8.x86_64                                               
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.x86_64                     
  fuse3-3.3.0-15.el8.x86_64                                                     
  fuse3-libs-3.3.0-15.el8.x86_64                                                
  iptables-libs-1.8.4-22.el8.x86_64                                             
  jansson-2.14-1.el8.x86_64                                                     
  jq-1.6-3.el8.x86_64                                                           
  kmod-25-19.el8.x86_64                                                         
  libibverbs-37.2-1.el8.x86_64                                                  
  libmnl-1.0.4-6.el8.x86_64                                                     
  libnet-1.1.6-15.el8.x86_64                                                    
  libnftnl-1.1.5-5.el8.x86_64                                                   
  libpcap-14:1.9.1-5.el8.x86_64                                                 
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.x86_64                         
  nftables-1:0.9.3-25.el8.x86_64                                                
  oniguruma-6.8.2-2.el8.x86_64                                                  
  protobuf-c-1.3.0-6.el8.x86_64                                                 
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.x86_64                           
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.x86_64                         
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.x86_64                      

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/d7/42/7ad4b6d67a16229496d4f6e74201bdbebcf4bc1e87d5a70c9297d4961bd2/PyYAML-6.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (701kB)
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Installing collected packages: argcomplete, PyYAML, toml, xmltodict, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 8b54ee5e164
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> e7f212a4b36
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> ae78e68dc26
STEP 14/23: COPY ./VERSION /
--> 8555e653f98
STEP 15/23: COPY ./devfiles /build/devfiles
--> cb34f484f79
STEP 16/23: WORKDIR /build/
--> cf4d23b9ed4
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 11.581s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.5s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 8805f762979
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> d8944b11686
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> f96206a824c
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 46e2d462033
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 47e365a53ce
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 863124c878d
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 0ca79bcd601
Successfully tagged localhost/devfileregistry:tmp
0ca79bcd60140f18c3b07213ccc55bc18905060836738f389de81ab871dcb2ea
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.RFIGIhdeVY/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA /tmp/tmp.TmNkFpPOV5/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA
--- /tmp/tmp.RFIGIhdeVY/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-10-26 05:07:11.000000000 -0400
+++ /tmp/tmp.TmNkFpPOV5/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-10-30 05:00:42.819418784 -0400
@@ -3,10 +3,10 @@
 Version: 6.0
 Summary: YAML parser and emitter for Python
 Home-page: https://pyyaml.org/
-Download-URL: https://pypi.org/project/PyYAML/
 Author: Kirill Simonov
 Author-email: xi@resolvent.net
 License: MIT
+Download-URL: https://pypi.org/project/PyYAML/
 Project-URL: Bug Tracker, https://github.com/yaml/pyyaml/issues
 Project-URL: CI, https://github.com/yaml/pyyaml/actions
 Project-URL: Documentation, https://pyyaml.org/wiki/PyYAMLDocumentation
@@ -43,3 +43,4 @@
 
 PyYAML is applicable for a broad range of tasks from complex
 configuration files to object serialization and persistence.
+
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.RFIGIhdeVY/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD /tmp/tmp.TmNkFpPOV5/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD
--- /tmp/tmp.RFIGIhdeVY/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-10-26 05:07:11.000000000 -0400
+++ /tmp/tmp.TmNkFpPOV5/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-10-30 05:00:42.819418784 -0400
@@ -1,8 +1,8 @@
 PyYAML-6.0.dist-info/INSTALLER,sha256=zuuue4knoyJ-UwPPXg8fezS7VCrXJQrAP7zeNuwvFQg,4
 PyYAML-6.0.dist-info/LICENSE,sha256=jTko-dxEkP1jVwfLiOsmvXZBAqcoKVQwfT5RZ6V36KQ,1101
-PyYAML-6.0.dist-info/METADATA,sha256=Q56A1jQxEnzMMCyqgYkqM5Egvr9y18VExGF3ciGLjlY,2005
+PyYAML-6.0.dist-info/METADATA,sha256=QmHx9kGp_0yezQCXYaft4eEFeJ6W4oyFfYwHDLP1kdg,2006
 PyYAML-6.0.dist-info/RECORD,,
-PyYAML-6.0.dist-info/WHEEL,sha256=VXb7H8_fWiBJHbEvxuDSYbC9VxfKWz2_woH0TyHF8yQ,104
+PyYAML-6.0.dist-info/WHEEL,sha256=RiwktpmF40OphKd3_aIG01PzIOQlJ7dpBn3cFSc9vak,217
 PyYAML-6.0.dist-info/top_level.txt,sha256=rpj0IVMTisAjh_1vG3Ccf9v5jpCQwAz6cD1IVU5ZdhQ,11
 _yaml/__init__.py,sha256=04Ae_5osxahpJHa3XBZUAf4wi6XX32gR8D6X6p64GEA,1402
 _yaml/__pycache__/__init__.cpython-38.pyc,,
@@ -24,6 +24,7 @@
 yaml/__pycache__/scanner.cpython-38.pyc,,
 yaml/__pycache__/serializer.cpython-38.pyc,,
 yaml/__pycache__/tokens.cpython-38.pyc,,
+yaml/_yaml.cpython-38-x86_64-linux-gnu.so,sha256=lMaKSmQZy3WNZSmmU0Wg5Y5ZAs-HR5vItyGVUIsp8Rg,2847784
 yaml/composer.py,sha256=_Ko30Wr6eDWUeUpauUGT3Lcg9QPBnOPVlTnIMRGJ9FM,4883
 yaml/constructor.py,sha256=kNgkfaeLUkwQYY_Q6Ff1Tz2XVw_pG1xVE9Ak7z-viLA,28639
 yaml/cyaml.py,sha256=6ZrAG9fAYvdVe2FK_w0hmXoG7ZYsoYUwapG8CiC72H0,3851
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.RFIGIhdeVY/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL /tmp/tmp.TmNkFpPOV5/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL
--- /tmp/tmp.RFIGIhdeVY/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-10-26 05:07:11.000000000 -0400
+++ /tmp/tmp.TmNkFpPOV5/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-10-30 05:00:42.819418784 -0400
@@ -1,5 +1,8 @@
 Wheel-Version: 1.0
-Generator: bdist_wheel (0.37.1)
+Generator: bdist_wheel (0.37.0)
 Root-Is-Purelib: false
-Tag: cp38-cp38-linux_ppc64le
+Tag: cp38-cp38-manylinux_2_5_x86_64
+Tag: cp38-cp38-manylinux1_x86_64
+Tag: cp38-cp38-manylinux_2_12_x86_64
+Tag: cp38-cp38-manylinux2010_x86_64
 
Only in /tmp/tmp.TmNkFpPOV5/lib/python3.8/site-packages/yaml: _yaml.cpython-38-x86_64-linux-gnu.so
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 0ca79bcd60140f18c3b07213ccc55bc18905060836738f389de81ab871dcb2ea
Deleted: 863124c878dd22e913259be7ae56a7b1ebf3c7d6483fe6915c392750c46c3b92
Deleted: 47e365a53cefb429c4ee8cdc67fd4ce31b7ebfa4ddcd9c932e8e2da5367ed9b5
Deleted: 46e2d46203355ef19514e52703766bbee808c82036d915dad71adc1406319f38
Deleted: f96206a824c35ab3886c54bb21e73eead2b9cdbb0233f891288dddb19662da0c
Deleted: d8944b11686c3f60805139e26959ea681b347e829eddb1297df66c1bec2d5971
Deleted: 8805f7629797035f13041d4999eb3f6714e61c4c466efdba60a1cbac74d2b8b5
Deleted: cf4d23b9ed4fee9fb86fecb1f61c289a9e685f6267e103633d1ddac51b34cb53
Deleted: cb34f484f79c0313879ca60d1d2f2805b161009446d66512ab86e7a01124377d
Deleted: 8555e653f981114667c9881b487aa832826b4f523e0d7b7bda7eea3e8674d32c
Deleted: ae78e68dc26bf4f02c76b419081b20900b536d3bf0829fa5ef5fd51606dce145
Deleted: e7f212a4b360538e264c88cd50f09e803d7c7476aeb0523d29ba7216e0f32295
Deleted: 8b54ee5e164f4ab4ed9be031ca73c89f4dd6dc3a2ede15c6b820c483c9af6da0
Deleted: f71b6a9e05698fa509f4660e7bb05ecc0aedb0761f72d66f316123e0e227fc92
Deleted: 82901f1953d5353df6420b96997012b813128b929fde5319595393244ed456a0
Deleted: d0dbc63b1eae9c515dd97a86026c15d754f7f7167a00cfb435d06ff5eb050d6d
Deleted: dc21cc83d05a67fde54f5904a783824dd0c9df15816a63809b72f28e08cbeec3
Deleted: fbaa88fa0181896eb9dea83331278f7f00452fb28fb3fbe0f7ea85802214f72b
Deleted: d00eb074a8e1053957037c729e5e5df926493134f7af6f78337c07610cf62741
Deleted: e4b5d4c34229d7ea412d32ffe1c9c23e14c660b0eaf9b92548b0cefdfc1f18c0
Deleted: 2cfedfc274826a724958bc8350c92c2317b048150621628d1cf7271dbc12f888
Deleted: 90b3f8e7e9789e511f7ecafcdccc14a171ed214858afe5e3392a9f9413da81d3
Uploading: root-local.tgz
File already uploaded: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
