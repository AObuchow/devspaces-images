======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> cba8c4defa9
STEP 3/23: ARG BOOTSTRAP=true
--> 3fbb56c6c87
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 95d5deca6b3
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 937470b67e2
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 197a2280b95
STEP 7/23: ARG ALLOWED_TAGS=""
--> 2e4ecfead98
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 95b8b36a1ed
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> d5590883e92
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 7e8bb031fb8
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=6525b9a38ed44731c0e5286ef668d572102fff9fa1578bb739d9eae2e5536706
  Stored in directory: /tmp/pip-ephem-wheel-cache-h7r8afrl/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: xmltodict, toml, PyYAML, argcomplete, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 08d6c28d9af
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> e49907bbe8b
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 5e309e79426
STEP 14/23: COPY ./VERSION /
--> 89d19717595
STEP 15/23: COPY ./devfiles /build/devfiles
--> 01e6c277357
STEP 16/23: WORKDIR /build/
--> b63a9b008e6
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 20.675s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.594s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 291cfe49025
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 31108501e28
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 73323eb76f9
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 90a476299bf
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> d9a55c8bbe5
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 61957e76615
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 820ef676e86
Successfully tagged localhost/devfileregistry:tmp
820ef676e86a99f189b7c37d65550b2dadee8037379b8b4fe7b47152b1034807
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.IcLJ7T9hfO/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA /tmp/tmp.Tz8P06CtlE/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA
--- /tmp/tmp.IcLJ7T9hfO/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-10-30 09:00:42.000000000 +0000
+++ /tmp/tmp.Tz8P06CtlE/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-10-31 15:34:26.131834741 +0000
@@ -3,10 +3,10 @@
 Version: 6.0
 Summary: YAML parser and emitter for Python
 Home-page: https://pyyaml.org/
+Download-URL: https://pypi.org/project/PyYAML/
 Author: Kirill Simonov
 Author-email: xi@resolvent.net
 License: MIT
-Download-URL: https://pypi.org/project/PyYAML/
 Project-URL: Bug Tracker, https://github.com/yaml/pyyaml/issues
 Project-URL: CI, https://github.com/yaml/pyyaml/actions
 Project-URL: Documentation, https://pyyaml.org/wiki/PyYAMLDocumentation
@@ -43,4 +43,3 @@
 
 PyYAML is applicable for a broad range of tasks from complex
 configuration files to object serialization and persistence.
-
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.IcLJ7T9hfO/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD /tmp/tmp.Tz8P06CtlE/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD
--- /tmp/tmp.IcLJ7T9hfO/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-10-30 09:00:42.000000000 +0000
+++ /tmp/tmp.Tz8P06CtlE/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-10-31 15:34:26.131834741 +0000
@@ -1,8 +1,8 @@
 PyYAML-6.0.dist-info/INSTALLER,sha256=zuuue4knoyJ-UwPPXg8fezS7VCrXJQrAP7zeNuwvFQg,4
 PyYAML-6.0.dist-info/LICENSE,sha256=jTko-dxEkP1jVwfLiOsmvXZBAqcoKVQwfT5RZ6V36KQ,1101
-PyYAML-6.0.dist-info/METADATA,sha256=QmHx9kGp_0yezQCXYaft4eEFeJ6W4oyFfYwHDLP1kdg,2006
+PyYAML-6.0.dist-info/METADATA,sha256=Q56A1jQxEnzMMCyqgYkqM5Egvr9y18VExGF3ciGLjlY,2005
 PyYAML-6.0.dist-info/RECORD,,
-PyYAML-6.0.dist-info/WHEEL,sha256=RiwktpmF40OphKd3_aIG01PzIOQlJ7dpBn3cFSc9vak,217
+PyYAML-6.0.dist-info/WHEEL,sha256=VXb7H8_fWiBJHbEvxuDSYbC9VxfKWz2_woH0TyHF8yQ,104
 PyYAML-6.0.dist-info/top_level.txt,sha256=rpj0IVMTisAjh_1vG3Ccf9v5jpCQwAz6cD1IVU5ZdhQ,11
 _yaml/__init__.py,sha256=04Ae_5osxahpJHa3XBZUAf4wi6XX32gR8D6X6p64GEA,1402
 _yaml/__pycache__/__init__.cpython-38.pyc,,
@@ -24,7 +24,6 @@
 yaml/__pycache__/scanner.cpython-38.pyc,,
 yaml/__pycache__/serializer.cpython-38.pyc,,
 yaml/__pycache__/tokens.cpython-38.pyc,,
-yaml/_yaml.cpython-38-x86_64-linux-gnu.so,sha256=lMaKSmQZy3WNZSmmU0Wg5Y5ZAs-HR5vItyGVUIsp8Rg,2847784
 yaml/composer.py,sha256=_Ko30Wr6eDWUeUpauUGT3Lcg9QPBnOPVlTnIMRGJ9FM,4883
 yaml/constructor.py,sha256=kNgkfaeLUkwQYY_Q6Ff1Tz2XVw_pG1xVE9Ak7z-viLA,28639
 yaml/cyaml.py,sha256=6ZrAG9fAYvdVe2FK_w0hmXoG7ZYsoYUwapG8CiC72H0,3851
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.IcLJ7T9hfO/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL /tmp/tmp.Tz8P06CtlE/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL
--- /tmp/tmp.IcLJ7T9hfO/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-10-30 09:00:42.000000000 +0000
+++ /tmp/tmp.Tz8P06CtlE/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-10-31 15:34:26.131834741 +0000
@@ -1,8 +1,5 @@
 Wheel-Version: 1.0
-Generator: bdist_wheel (0.37.0)
+Generator: bdist_wheel (0.37.1)
 Root-Is-Purelib: false
-Tag: cp38-cp38-manylinux_2_5_x86_64
-Tag: cp38-cp38-manylinux1_x86_64
-Tag: cp38-cp38-manylinux_2_12_x86_64
-Tag: cp38-cp38-manylinux2010_x86_64
+Tag: cp38-cp38-linux_ppc64le
 
Only in /tmp/tmp.IcLJ7T9hfO/lib/python3.8/site-packages/yaml: _yaml.cpython-38-x86_64-linux-gnu.so
***** END DIFF
DIFF START *****
diff --suppress-common-lines -u -r /tmp/tmp.xWwbcXh08U/devfiles/04_python/meta.yaml /tmp/tmp.nHSIkRgS9J/devfiles/04_python/meta.yaml
--- /tmp/tmp.xWwbcXh08U/devfiles/04_python/meta.yaml	2022-10-27 08:29:53.000000000 +0000
+++ /tmp/tmp.nHSIkRgS9J/devfiles/04_python/meta.yaml	2022-10-31 15:34:27.621798274 +0000
@@ -1,5 +1,5 @@
 displayName: Python
-description: Python Stack with Python 3.8 and pip 19.3
+description: Python Stack with Python 3.9 and pip
 tags:
   - Python
   - pip
diff --suppress-common-lines -u -r /tmp/tmp.xWwbcXh08U/devfiles/index.json /tmp/tmp.nHSIkRgS9J/devfiles/index.json
--- /tmp/tmp.xWwbcXh08U/devfiles/index.json	2022-10-27 08:29:53.000000000 +0000
+++ /tmp/tmp.nHSIkRgS9J/devfiles/index.json	2022-10-31 15:34:27.621798274 +0000
@@ -96,7 +96,7 @@
   },
   {
     "displayName": "Python",
-    "description": "Python Stack with Python 3.8 and pip 19.3",
+    "description": "Python Stack with Python 3.9 and pip",
     "tags": [
       "Python",
       "pip",
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 820ef676e86a99f189b7c37d65550b2dadee8037379b8b4fe7b47152b1034807
Deleted: 61957e766158ca1a1b0c55e683c7f639e313fcecf6e4afb9e13a0dacc5743a85
Deleted: d9a55c8bbe5263090da31d9645d71fb5ab57b25b096f6be58d74ccb8e018e7a3
Deleted: 90a476299bff92a4193daea61e5622fb42a5a81f5ff08af42f24015452e76583
Deleted: 73323eb76f902c84c0b12bc81350c6a5d0ee147e45ff68ede13a9ead7712da5a
Deleted: 31108501e289f0b6299df70eb4497857665538e3da7b8b78c077102acd767e12
Deleted: 291cfe4902537f16c3b9762dca8891966090a83be942d81b9fa47ca20cb1e483
Deleted: b63a9b008e6c5ef72e2fb508920ecec5264fac56bc1d75ed7c8ae39eff4eb7b8
Deleted: 01e6c277357ea63c82f786689c47e723de2b5da81f60f50af867056c2f104711
Deleted: 89d197175951dc066189e2cffc50724ee8af285514fcfaad287987f8551f41bf
Deleted: 5e309e79426055ed7ff2b207cb429f61693b0d8804ece5c1826d4370eae8d746
Deleted: e49907bbe8b010705ff4ca72ee14c7308b22ace9d88fb33011c18b1d705078b4
Deleted: 08d6c28d9afa3eb1764294f6aa56b62678b48966c4e05767f19f8b81e0885bda
Deleted: 7e8bb031fb87f07bb4fda6c72a276ff779419dee418fcd733790b3d2a6ba6949
Deleted: d5590883e923de3186258bd65405ff2c0d42be63f910e5b8fedafb694bb04711
Deleted: 95b8b36a1ed09de35075b319af1f0beb8627cd547f8f454a2d1ad787efc408a0
Deleted: 2e4ecfead983bf296a5cf72b54e73e6ab36d4f9139d11620a808d7388ed8d940
Deleted: 197a2280b959d1165143db01701911dde51cf73a0a715b50e59f690627e7c5ca
Deleted: 937470b67e2abd463cddb450929ebf933e8511bc3114e9c6ad3b16a89494cf3c
Deleted: 95d5deca6b3dce54370cfb79bb01885a0e47e0a3d40755dec898e6921ffff5a8
Deleted: 3fbb56c6c876a446c7f97ff15b6efd46f13c21dd530f7cc1bb493ea3e08ff594
Deleted: cba8c4defa94bd97014d8cee65f79d218b2494da7358372c2e7f3b691f14fc54
Uploading: root-local.tgz
Uploading: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
