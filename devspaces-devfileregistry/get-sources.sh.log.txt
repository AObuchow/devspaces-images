======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> c64fbdb565c
STEP 3/23: ARG BOOTSTRAP=true
--> e852afa78ca
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 5a9a40af7b3
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> e740dbe5484
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 1f9e4829238
STEP 7/23: ARG ALLOWED_TAGS=""
--> 97366027473
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> d15f61405d5
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 25f4c420e5c
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 238dce8b79d
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=4abe872940b0f1e0547d8dc737df9f203a7c473e62d5b165008c0c2c190b876b
  Stored in directory: /tmp/pip-ephem-wheel-cache-y9zsckn8/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: xmltodict, PyYAML, argcomplete, toml, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 01fb8303c4a
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> aca8851e9ba
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 98172492180
STEP 14/23: COPY ./VERSION /
--> af699117ccd
STEP 15/23: COPY ./devfiles /build/devfiles
--> c6c6c60af3d
STEP 16/23: WORKDIR /build/
--> 977b0a9b8bc
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 11.679s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.289s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 4acbf95fcf5
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> aefba3ac16a
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 54542406c40
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 362565d896f
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> e375ddf1aea
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 99a028d6a82
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 66e209434cd
Successfully tagged localhost/devfileregistry:tmp
66e209434cda3bba188e2cca4afa6f57575fe03b7cc6332864a9f87f0fd74d90
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.q0pZBKQsNg/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA /tmp/tmp.cKZzvZvQb1/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA
--- /tmp/tmp.q0pZBKQsNg/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-11-06 08:59:13.000000000 +0000
+++ /tmp/tmp.cKZzvZvQb1/lib/python3.8/site-packages/PyYAML-6.0.dist-info/METADATA	2022-11-06 10:41:00.784508459 +0000
@@ -3,10 +3,10 @@
 Version: 6.0
 Summary: YAML parser and emitter for Python
 Home-page: https://pyyaml.org/
+Download-URL: https://pypi.org/project/PyYAML/
 Author: Kirill Simonov
 Author-email: xi@resolvent.net
 License: MIT
-Download-URL: https://pypi.org/project/PyYAML/
 Project-URL: Bug Tracker, https://github.com/yaml/pyyaml/issues
 Project-URL: CI, https://github.com/yaml/pyyaml/actions
 Project-URL: Documentation, https://pyyaml.org/wiki/PyYAMLDocumentation
@@ -43,4 +43,3 @@
 
 PyYAML is applicable for a broad range of tasks from complex
 configuration files to object serialization and persistence.
-
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.q0pZBKQsNg/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD /tmp/tmp.cKZzvZvQb1/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD
--- /tmp/tmp.q0pZBKQsNg/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-06 08:59:13.000000000 +0000
+++ /tmp/tmp.cKZzvZvQb1/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-06 10:41:00.784508459 +0000
@@ -1,8 +1,8 @@
 PyYAML-6.0.dist-info/INSTALLER,sha256=zuuue4knoyJ-UwPPXg8fezS7VCrXJQrAP7zeNuwvFQg,4
 PyYAML-6.0.dist-info/LICENSE,sha256=jTko-dxEkP1jVwfLiOsmvXZBAqcoKVQwfT5RZ6V36KQ,1101
-PyYAML-6.0.dist-info/METADATA,sha256=QmHx9kGp_0yezQCXYaft4eEFeJ6W4oyFfYwHDLP1kdg,2006
+PyYAML-6.0.dist-info/METADATA,sha256=Q56A1jQxEnzMMCyqgYkqM5Egvr9y18VExGF3ciGLjlY,2005
 PyYAML-6.0.dist-info/RECORD,,
-PyYAML-6.0.dist-info/WHEEL,sha256=RiwktpmF40OphKd3_aIG01PzIOQlJ7dpBn3cFSc9vak,217
+PyYAML-6.0.dist-info/WHEEL,sha256=EqgGnsHwLeMuy-o1qe2FFb6uZwTmuDfCjXdcn9XxD8k,104
 PyYAML-6.0.dist-info/top_level.txt,sha256=rpj0IVMTisAjh_1vG3Ccf9v5jpCQwAz6cD1IVU5ZdhQ,11
 _yaml/__init__.py,sha256=04Ae_5osxahpJHa3XBZUAf4wi6XX32gR8D6X6p64GEA,1402
 _yaml/__pycache__/__init__.cpython-38.pyc,,
@@ -24,7 +24,6 @@
 yaml/__pycache__/scanner.cpython-38.pyc,,
 yaml/__pycache__/serializer.cpython-38.pyc,,
 yaml/__pycache__/tokens.cpython-38.pyc,,
-yaml/_yaml.cpython-38-x86_64-linux-gnu.so,sha256=lMaKSmQZy3WNZSmmU0Wg5Y5ZAs-HR5vItyGVUIsp8Rg,2847784
 yaml/composer.py,sha256=_Ko30Wr6eDWUeUpauUGT3Lcg9QPBnOPVlTnIMRGJ9FM,4883
 yaml/constructor.py,sha256=kNgkfaeLUkwQYY_Q6Ff1Tz2XVw_pG1xVE9Ak7z-viLA,28639
 yaml/cyaml.py,sha256=6ZrAG9fAYvdVe2FK_w0hmXoG7ZYsoYUwapG8CiC72H0,3851
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.q0pZBKQsNg/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL /tmp/tmp.cKZzvZvQb1/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL
--- /tmp/tmp.q0pZBKQsNg/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-06 08:59:13.000000000 +0000
+++ /tmp/tmp.cKZzvZvQb1/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-06 10:41:00.784508459 +0000
@@ -1,8 +1,5 @@
 Wheel-Version: 1.0
-Generator: bdist_wheel (0.37.0)
+Generator: bdist_wheel (0.38.2)
 Root-Is-Purelib: false
-Tag: cp38-cp38-manylinux_2_5_x86_64
-Tag: cp38-cp38-manylinux1_x86_64
-Tag: cp38-cp38-manylinux_2_12_x86_64
-Tag: cp38-cp38-manylinux2010_x86_64
+Tag: cp38-cp38-linux_ppc64le
 
Only in /tmp/tmp.q0pZBKQsNg/lib/python3.8/site-packages/yaml: _yaml.cpython-38-x86_64-linux-gnu.so
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 66e209434cda3bba188e2cca4afa6f57575fe03b7cc6332864a9f87f0fd74d90
Deleted: 99a028d6a82fea2e8009d93ee41eaecaa00a2f9d057933aee8f61d0fabb57bfb
Deleted: e375ddf1aea034a29f6f10b42da2d4bdb63c767fb0145436bc426043f60d6187
Deleted: 362565d896fca94102976a24429f51ec6b5ea06f640e96de578808f3f3978627
Deleted: 54542406c40135aa3ff0ba32631aa2019e63172de1a255fc505dae55e3a2dbe8
Deleted: aefba3ac16abbae383928f6f0d618cd958ccc512fb944b942faf4deaf9dd5274
Deleted: 4acbf95fcf5dc35b1720ce3d050bf91267127eba597540916bf9a6ee7168fafb
Deleted: 977b0a9b8bc2f42f3d06a6baf5c4d3a9a97146c6b3e5734ae6370585e1f16ab2
Deleted: c6c6c60af3d332fe74af7347f258217b691e6b1705e51b244e4e53da0295caab
Deleted: af699117ccde124f754c81e36a913eb84a65f228a29c15dea0727f06b4496c83
Deleted: 9817249218082deb996e33ebb336d2d3fc3036da75f35fc696e2bb2a1a18a962
Deleted: aca8851e9ba1b9e005fcef8e413dbf4f3d823506c6a7a248dc1c2d544ac9fdcc
Deleted: 01fb8303c4a0c555c4e40ea129939bdc3e7aa3e3f34d2c8948c4c3cef8178897
Deleted: 238dce8b79d60413fdedb3c3246fded29df818dd4ff87be0afac9a7f232c99d0
Deleted: 25f4c420e5c05521bb227c4444abce0ca4b426c2448af3399a45d3998b9abff7
Deleted: d15f61405d5699791d50b811837fd8533c88a095155ee36c9461b2155eedeb55
Deleted: 97366027473811da2c226629b5fdbf6480101655b874f97c64c1d73156d8192a
Deleted: 1f9e4829238533b382fa187f0a18cbfa794c6543d51b17c4161c343cc47364d3
Deleted: e740dbe5484f6489b41e2e927d932a55da3a3bd22589dfbc4e50cb3432d73e53
Deleted: 5a9a40af7b34df80a9e1b542bbfe41cb1720d86cba3c0dd7dd1f6310593d70a1
Deleted: e852afa78cad554601dc0b22b729de796b801e9ae6a0e6bc9606e2097c4cf4db
Deleted: c64fbdb565c36a964e6b8273dc929bff19c6aec5ce9403ba67c41d823bd337d9
Uploading: root-local.tgz
File already uploaded: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
