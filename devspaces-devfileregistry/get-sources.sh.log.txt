======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> ed9f0f7af1b
STEP 3/23: ARG BOOTSTRAP=true
--> 75e22f91d97
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 76492fcb050
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 2756422f431
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 13856bae939
STEP 7/23: ARG ALLOWED_TAGS=""
--> fc25ceaf840
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> c70305502e2
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> e0f085ad1f0
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 241a0870d39
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=405115e071fc2c31d9af434e5085282f87b1955cbf9d1381e5f558fb60c5aa83
  Stored in directory: /tmp/pip-ephem-wheel-cache-m_okou7n/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: xmltodict, argcomplete, toml, PyYAML, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 06e780bbdc9
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 0cf89521a15
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> b59dc4d68ed
STEP 14/23: COPY ./VERSION /
--> 11415d973b5
STEP 15/23: COPY ./devfiles /build/devfiles
--> f86f980758b
STEP 16/23: WORKDIR /build/
--> 6b1a9f8b35d
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 10.5s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.112s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> ca585fe815d
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 90ad1f7d56c
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> c009d0a0fa7
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 404a2499d43
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 16b57971a1c
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 235758c4d43
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> a0614d600d6
Successfully tagged localhost/devfileregistry:tmp
a0614d600d6e97cee298b2782b0e1515fb496c46f51bd5ed3e2f0ba123435fb3
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: a0614d600d6e97cee298b2782b0e1515fb496c46f51bd5ed3e2f0ba123435fb3
Deleted: 235758c4d4347f9df4e425809d2b32edd63c4ff9626a31c855776aa7d5a374da
Deleted: 16b57971a1c873be5799ae46a05a75c6495a096fb838a7ba527ebcce542cf68e
Deleted: 404a2499d43549986ea4c6f7224ffc80ee115b7c0af852d20763380d7deb2c15
Deleted: c009d0a0fa7db04c144c1b511e0e742da1578d2b7744813137b10e3de196e31b
Deleted: 90ad1f7d56c8127571159871c3bcadd5a1f656d23932edfa32b73b4033e8baa0
Deleted: ca585fe815dea92948ea5c4cbecdc16f599cba96ace9bfd53595ed7812849324
Deleted: 6b1a9f8b35d5e9515400acf9fb165fde570931c6a58be7a3f0b9c90a30c89eff
Deleted: f86f980758b905d063276f6270a5530cad68f4756d8f59d91af8023d14348d0e
Deleted: 11415d973b5d855e4e29e326afae44cb0bcdbb25628f5fd9e5fefcecae99ac37
Deleted: b59dc4d68edf38b72490ef1cd5d5f9f56a9786cc2db986f05af939afdbbfd1f9
Deleted: 0cf89521a15a855a3884dc1c5a28a1639f772f75a0f6bbf8c7772012acda9ab9
Deleted: 06e780bbdc9801b07152f075d8a88dd3df8105ff80ee07960f45d64f027d3123
Deleted: 241a0870d39814cd664ef5178ea7f0c5d8810679c894197485d37a19a6742b33
Deleted: e0f085ad1f0baff3a3a0fecb3dd5d2fd8a33a322060b867a7c59de9f4c49d7bc
Deleted: c70305502e2b254fcc33326bafaf6693fb029518ee8f3137bbd4f0d4d12392e7
Deleted: fc25ceaf8408660a75bd140b0218cab05546fdb942b6f3d3ecca00b3ac55e018
Deleted: 13856bae939bd059c824a9d6b726eb922ddbc16e030a2b7385f7684b3bbda1c5
Deleted: 2756422f431274f53e85d488cd944e5c739c518d34cfa9d3436650d15ae9f91a
Deleted: 76492fcb050b8d78157aa97076ffdc50399bc44ab2d657070528a90bc30cdb92
Deleted: 75e22f91d97cfbee69ecf563893db2c44dce47c7dfa24d1bc776162b6cb87b7e
Deleted: ed9f0f7af1b38204217d86de1b9767e337a2bdee58b52385a1f043883c2a10dc
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
