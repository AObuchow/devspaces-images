======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> f5f49d0b668
STEP 3/23: ARG BOOTSTRAP=true
--> b51632f3e51
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 69cf214e80e
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 2c52cd75332
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 5d396c5ae84
STEP 7/23: ARG ALLOWED_TAGS=""
--> f6becf38fcc
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 83e6feb8f24
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 3cbf6a5e1da
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> ec0102f9fb0
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45334 sha256=d6688d930a8281ea74e070eb28f8ae79b7b3729c30b172dba86362ecb975c274
  Stored in directory: /tmp/pip-ephem-wheel-cache-w9djk5ig/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: argcomplete, xmltodict, PyYAML, toml, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> deabfbb450b
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 112c6f02bac
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> aa19f83a1b8
STEP 14/23: COPY ./VERSION /
--> a4250ee6a46
STEP 15/23: COPY ./devfiles /build/devfiles
--> a73d36bf0fd
STEP 16/23: WORKDIR /build/
--> 087dca2e740
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 23.826s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 3.422s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 23821532e11
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 1774f85dfd0
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> e1e7c853790
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> ed39f7ca026
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> bd2036e4c00
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> fea9263a924
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> f85ec5fdb76
Successfully tagged localhost/devfileregistry:tmp
f85ec5fdb76ca7955060836dc278fc1a3f17a81b2398104b72ff68ca4d76fbef
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.euSizZp858/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD /tmp/tmp.qUAUs46bQ4/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD
--- /tmp/tmp.euSizZp858/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-03 18:55:03.000000000 +0000
+++ /tmp/tmp.qUAUs46bQ4/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-04 22:23:47.396878178 +0000
@@ -2,7 +2,7 @@
 PyYAML-6.0.dist-info/LICENSE,sha256=jTko-dxEkP1jVwfLiOsmvXZBAqcoKVQwfT5RZ6V36KQ,1101
 PyYAML-6.0.dist-info/METADATA,sha256=Q56A1jQxEnzMMCyqgYkqM5Egvr9y18VExGF3ciGLjlY,2005
 PyYAML-6.0.dist-info/RECORD,,
-PyYAML-6.0.dist-info/WHEEL,sha256=VXb7H8_fWiBJHbEvxuDSYbC9VxfKWz2_woH0TyHF8yQ,104
+PyYAML-6.0.dist-info/WHEEL,sha256=aLXks5hcaJQ7h3QsaBp1z3dnJmBen9oUtgRUng3aYug,104
 PyYAML-6.0.dist-info/top_level.txt,sha256=rpj0IVMTisAjh_1vG3Ccf9v5jpCQwAz6cD1IVU5ZdhQ,11
 _yaml/__init__.py,sha256=04Ae_5osxahpJHa3XBZUAf4wi6XX32gR8D6X6p64GEA,1402
 _yaml/__pycache__/__init__.cpython-38.pyc,,
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.euSizZp858/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL /tmp/tmp.qUAUs46bQ4/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL
--- /tmp/tmp.euSizZp858/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-03 18:55:03.000000000 +0000
+++ /tmp/tmp.qUAUs46bQ4/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-04 22:23:47.396878178 +0000
@@ -1,5 +1,5 @@
 Wheel-Version: 1.0
-Generator: bdist_wheel (0.37.1)
+Generator: bdist_wheel (0.38.1)
 Root-Is-Purelib: false
 Tag: cp38-cp38-linux_ppc64le
 
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: f85ec5fdb76ca7955060836dc278fc1a3f17a81b2398104b72ff68ca4d76fbef
Deleted: fea9263a924f46887b84d677ddd5629659bc6ea108cb1ffd2c237a32ac219565
Deleted: bd2036e4c0050a0872d824f2628327857a7b62838a40761cf582b58909e5774a
Deleted: ed39f7ca0269d1ec9cfb6101ac7988384a34118e5deb059c2db944e1d69d139b
Deleted: e1e7c853790af305c17a042f7bbf8cf5e6d1806ce070084f7044db28df3d4477
Deleted: 1774f85dfd040ed2e2d37f5ba51db7dfb7ba0968fdeae58ab7ec452d49e443e0
Deleted: 23821532e11cd0a004b63c25a19aeca7b5b6c7a3ab98327001896fafc8595698
Deleted: 087dca2e7404b758b3e49b3658669bde7db783f825d3ea2c9d01a546cdd09e03
Deleted: a73d36bf0fde805d392d4d989fc7e1785e885e7209646e8d8de016f52345f8af
Deleted: a4250ee6a4628e2f3d4eeb0c03369e22a48c6a74c4f46c48abcc1a2b815581f1
Deleted: aa19f83a1b8ea7b694a3f79a56afb21fe5f84ea329e06690f32fb3e9487e967c
Deleted: 112c6f02bacd6d746539af26dcb584f8b5ef5e63f733e8568debf89def2b4b8e
Deleted: deabfbb450b9f4690739de45704ba7665bdfbca95024eb4bb5e57b452cbdda1b
Deleted: ec0102f9fb0831bfe21650761db00c04d87fe35c909847e501ffbf64a995c20a
Deleted: 3cbf6a5e1da9f13385866cdeb444fca3a14f757cbec2af4a273eb25c7cfdbd60
Deleted: 83e6feb8f24cc3abbcbda8393ec5d8d8a6c081a0c7ba3d932e5dd923b2a3a450
Deleted: f6becf38fccb0d9d99a17ecff0ffaf2033b0aae22c5a188a12a19c102d21d5a2
Deleted: 5d396c5ae8461a8cd864652b463e66e77cb6a4dd9716ae6d415c492f3cddf675
Deleted: 2c52cd75332e778bb3d105f7176e3ca2d84c5991125719bdcc625227fabe6795
Deleted: 69cf214e80ee01c4313551753f3497f13e28608b67bb82a48a1441488637d57a
Deleted: b51632f3e517f638b722e7d9bb8c3f35fe76f06445b8cced4df476cf85fa00f2
Deleted: f5f49d0b668ff3e7535e2ddca936e62233b41d7e3dfc3ba60b69d37faf1e4c47
Uploading: root-local.tgz
File already uploaded: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
