======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> c7439e316f3
STEP 3/23: ARG BOOTSTRAP=true
--> 91667261b18
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> 76dae14ea69
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> ec069baf302
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 54aee5bc627
STEP 7/23: ARG ALLOWED_TAGS=""
--> ab23d59ae87
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 26fed9e4ff8
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> d9923bb72fd
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 7c827513dbe
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  dnf-4.7.0-11.el8.noarch                                                       
  dnf-data-4.7.0-11.el8.noarch                                                  
  nodejs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le                      
  nodejs-docs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.noarch                  
  nodejs-full-i18n-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le            
  npm-1:6.14.17-1.14.20.1.2.module+el8.7.0+16991+b0a68a3e.ppc64le               
  python3-dnf-4.7.0-11.el8.noarch                                               
  python38-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                       
  python38-devel-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                 
  python38-libs-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                  
  python38-pip-19.3.1-6.module+el8.7.0+15823+8950cfa7.noarch                    
  tar-2:1.30-6.el8.ppc64le                                                      
  yum-4.7.0-11.el8.noarch                                                       
Installed:
  containers-common-2:1-43.module+el8.7.0+17064+3b31f55c.ppc64le                
  criu-3.15-3.module+el8.7.0+17064+3b31f55c.ppc64le                             
  fuse-common-3.3.0-16.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.7.0+17064+3b31f55c.ppc64le                    
  fuse3-3.3.0-16.el8.ppc64le                                                    
  fuse3-libs-3.3.0-16.el8.ppc64le                                               
  iptables-libs-1.8.4-23.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-41.0-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  nftables-1:0.9.3-26.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  rpm-plugin-systemd-inhibit-4.14.3-23.el8.ppc64le                              
  runc-1:1.1.4-1.module+el8.7.0+17064+3b31f55c.ppc64le                          
  skopeo-2:1.9.3-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.7.0+17064+3b31f55c.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=119c630be9de07ac817f7f20b8ed89b6175f5f987a34eff3a943084821b6af51
  Stored in directory: /tmp/pip-ephem-wheel-cache-nnv3671g/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: toml, xmltodict, PyYAML, argcomplete, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.13
yq: yq 3.1.0
jq: jq-1.6
--> 895225d3669
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 0b4a68776eb
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> ebdec4a4fa1
STEP 14/23: COPY ./VERSION /
--> f3c2125530d
STEP 15/23: COPY ./devfiles /build/devfiles
--> d14cf9514f4
STEP 16/23: WORKDIR /build/
--> 7f684f78ff1
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 10.526s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 5.912s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 66070bedafe
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 180f654e60d
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - 3.4 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 4aeb9753a4a
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_dotnet/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> a3565b735a7
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> b141aae04e6
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 87cfa6c8051
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> aa6d8e77625
Successfully tagged localhost/devfileregistry:tmp
aa6d8e77625cf3e39f8a674cc2d5a4567475b4ca13eec7b8cd4fa0ba986a91d9
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: aa6d8e77625cf3e39f8a674cc2d5a4567475b4ca13eec7b8cd4fa0ba986a91d9
Deleted: 87cfa6c8051628ec44af4eae7e7e9284da5b8ba519f06ba334d36be2a34a6947
Deleted: b141aae04e65438f264e2a207a43ebd5eb257af97256cf42a72e063731ba3dc3
Deleted: a3565b735a7709f987ccf512d6e94cc44388517ff2329350742f8c1b6bc6acc2
Deleted: 4aeb9753a4a60eadd55d99ad943dfcbe484bec91e6d567232f99481dac05f250
Deleted: 180f654e60d57225d3461fe1805e8093778e07eef6f0c3c3aa553a4e287b9ed8
Deleted: 66070bedafed6ef728bc490cc967f00cde4cf318c8c88123f0b9915968517378
Deleted: 7f684f78ff1066e1cbc5ac3871f8e368354755b713a910b5066a5b3a261b1eec
Deleted: d14cf9514f4314022aa320b0ab295fc8183442ae7620ed96e5e48ddeb50e799c
Deleted: f3c2125530ddb05f146c78006bf4f62766ebbdbac468e32b8fa9799bd1f714d8
Deleted: ebdec4a4fa19c19a85a2673b558f9ed1c1ebb26ce33ce3e97cc87df7b14caacc
Deleted: 0b4a68776eb89d8f900dccc62823728fecdec84d8749f08911bf4a768ab9b0b5
Deleted: 895225d3669935ad4500600bfb8a22936d25264dfabcc3f60bdfbeaa86b0ef0f
Deleted: 7c827513dbe50cf8a87564529ecc055d6a2f7b12af7f4380a87071d6ece94528
Deleted: d9923bb72fdcce48d2aa49076e4b50a9d61d123fb240519fbc77ec1e21e2badf
Deleted: 26fed9e4ff8fdfcf32a227cd26b4bf5c4aae7fcaab62884b7f06b28e8c8788ae
Deleted: ab23d59ae87dbc966b85a2b2d36ce81b644f1da7b39f85fdb4fc5e84956e3a0a
Deleted: 54aee5bc6274fb9961a9ca25b1d5f2d3315f284e168bfce2189ed2afefa021f7
Deleted: ec069baf30275120dc69c7468d03ca756bfdedfa09098878fdd8057ac1651c43
Deleted: 76dae14ea69fc5163f04e042a31780b90893bdcd20671fdac569f8c79ef09e9d
Deleted: 91667261b1878cdc4f04e337beb20397cdb8b753ecbec38997a71f2570e759bb
Deleted: c7439e316f34c5aaeed166a943c889beeb9b3c5ee89b7af5c56340ae99b05ab3
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
