======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> b044c17275c
STEP 3/23: ARG BOOTSTRAP=true
--> 2ae489d163f
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> cabfcb8d515
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 2c34c7c9d69
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 617e170253f
STEP 7/23: ARG ALLOWED_TAGS=""
--> 81920951081
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> b522bb7a429
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 6c2dededf89
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 57d88a3e076
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  dnf-4.7.0-11.el8.noarch                                                       
  dnf-data-4.7.0-11.el8.noarch                                                  
  nodejs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le                      
  nodejs-docs-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.noarch                  
  nodejs-full-i18n-1:14.20.1-2.module+el8.7.0+16991+b0a68a3e.ppc64le            
  npm-1:6.14.17-1.14.20.1.2.module+el8.7.0+16991+b0a68a3e.ppc64le               
  python3-dnf-4.7.0-11.el8.noarch                                               
  python38-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                       
  python38-devel-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                 
  python38-libs-3.8.13-1.module+el8.7.0+15641+2ece4388.ppc64le                  
  python38-pip-19.3.1-6.module+el8.7.0+15823+8950cfa7.noarch                    
  tar-2:1.30-6.el8.ppc64le                                                      
  yum-4.7.0-11.el8.noarch                                                       
Installed:
  containers-common-2:1-43.module+el8.7.0+17064+3b31f55c.ppc64le                
  criu-3.15-3.module+el8.7.0+17064+3b31f55c.ppc64le                             
  fuse-common-3.3.0-16.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.7.0+17064+3b31f55c.ppc64le                    
  fuse3-3.3.0-16.el8.ppc64le                                                    
  fuse3-libs-3.3.0-16.el8.ppc64le                                               
  iptables-libs-1.8.4-23.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-41.0-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  nftables-1:0.9.3-26.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  rpm-plugin-systemd-inhibit-4.14.3-23.el8.ppc64le                              
  runc-1:1.1.4-1.module+el8.7.0+17064+3b31f55c.ppc64le                          
  skopeo-2:1.9.3-1.module+el8.7.0+17064+3b31f55c.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.7.0+17064+3b31f55c.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=52aa6f550857d056c08c30d2839b3406b5cab3af18475cc6765fb80e77b3f046
  Stored in directory: /tmp/pip-ephem-wheel-cache-wbdumtbh/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: xmltodict, PyYAML, toml, argcomplete, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.13
yq: yq 3.1.0
jq: jq-1.6
--> e197427f6a9
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> ada111a8aeb
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 97951dd076a
STEP 14/23: COPY ./VERSION /
--> 6b0037504a9
STEP 15/23: COPY ./devfiles /build/devfiles
--> 04d8bc471dd
STEP 16/23: WORKDIR /build/
--> f3e2d1c8981
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 9.939s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.867s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 2a7fd08fa66
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> 6f0370c0d67
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.4 PASS - 3.4 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.4 PASS - 3.4 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 9e4c44ce458
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> c144edcb3f1
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 0333755be28
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> 576cdeb5ac6
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> da4a1a69b4f
Successfully tagged localhost/devfileregistry:tmp
da4a1a69b4ff6ec3c4a02b90918df0b840b5a8d291f71384ba30c45663079981
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: da4a1a69b4ff6ec3c4a02b90918df0b840b5a8d291f71384ba30c45663079981
Deleted: 576cdeb5ac62ce4b8d9e170d47ac6ad3a034cf02c9dfce6973183641afe4b74c
Deleted: 0333755be283ff5e2bc54d190eec17fcb263e568400cf2fbd30b01f5c709b9c1
Deleted: c144edcb3f1b32cc83e0ce86c957d5d1a9da2b835e3aa79dc95931c04a595514
Deleted: 9e4c44ce458cff188080ce01ca56f7a801a134a8cfa940ba2e8d074a355e1753
Deleted: 6f0370c0d67dd2ed13e83844da56de480877c27051eede0fb54762f2717817e5
Deleted: 2a7fd08fa6646fcc952452a7e6175aa1f33784ace16b3059333e769b06156c06
Deleted: f3e2d1c898147f48f5115ed02005590343feeef1eb205924fdd517593e72eb0e
Deleted: 04d8bc471dd6eb6646f33aac94bd88e7388b27511081d78f4725c383719910a6
Deleted: 6b0037504a90580c7af9602a6d391bf3fce0f76449820c19b9f2c6684cec190d
Deleted: 97951dd076a5f3c3cafca1c9ad0286993977899ec96006ee10123d3ab69aafa7
Deleted: ada111a8aeba429c87f5a0ecf65c0bcc76888b3951e1022c96d42502b153461b
Deleted: e197427f6a909014b419acd93b06741e15a4fcd2845e89a395239b711fdd9afa
Deleted: 57d88a3e076d70f2940dbd9540fcaae8d0775ddc229930d8e8a98df68defb1d2
Deleted: 6c2dededf89c29ac0447c4aa329ad86a378ae072ed5d178ea9eba556105708c5
Deleted: b522bb7a429db37f9864d2a2798df0b39188b9294b64c01f6a8fda2deca180c3
Deleted: 819209510816607302cc040265a747896f78610aadb0134fdd0ea5f09dabff80
Deleted: 617e170253f280cb23aef27ee1a75f1b8e824214fd7f346c02773e4cbd2f6c03
Deleted: 2c34c7c9d69ef5dea01c137b68b8d5748a40edc6899e977ee80ddaf6bc774f9a
Deleted: cabfcb8d5159f2d85b9bb47f96e4fe28daf0c3d7f6ee0de5b05b41edd5870ec4
Deleted: 2ae489d163f49af1c919ed80dfe8154c6758c86d3481cf0b61c8c9b40316b390
Deleted: b044c17275cba6226c16861c1194b16b1dfc13fff17d48203b4f77871895c9bf
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
