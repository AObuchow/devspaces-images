======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> 950b7c04b9f
STEP 3/23: ARG BOOTSTRAP=true
--> 819dc040cfc
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> aef4bc7ea43
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> b5c8aba0bd4
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 29fccca86f1
STEP 7/23: ARG ALLOWED_TAGS=""
--> 8d5c3b223fd
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> 2e569e07c5d
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 6d298137322
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> dc143b2f74a
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=580d96e95b6ac9fbc22cfa311c98fd5490ec44cf8b154cfb1134e4c6456fbadd
  Stored in directory: /tmp/pip-ephem-wheel-cache-btieua6b/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: argcomplete, toml, xmltodict, PyYAML, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> 90da6bf0afa
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 576d219343a
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 889b7e5b184
STEP 14/23: COPY ./VERSION /
--> a579793cf49
STEP 15/23: COPY ./devfiles /build/devfiles
--> d8c9f9d19a9
STEP 16/23: WORKDIR /build/
--> 29d0d62805a
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 10.297s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.942s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> b1949b7c771
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> a90b55f35ec
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> d29c69a2d7e
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> d04d91e11d3
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> a4dcfc5c10f
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> be5db03ac69
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 42d032849aa
Successfully tagged localhost/devfileregistry:tmp
42d032849aa7829dae07a45d75f81c1a1710ca224f0ca126b47f09aeb37bd9b9
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
Untagged: localhost/devfileregistry:tmp
Deleted: 42d032849aa7829dae07a45d75f81c1a1710ca224f0ca126b47f09aeb37bd9b9
Deleted: be5db03ac69a1373003c830d82b633dca486f0665b4eac9e5defb487c7f66dc6
Deleted: a4dcfc5c10ffa4c98397c843d66213309bcfeb0e496b2d09cfb341669d761b31
Deleted: d04d91e11d38bf00d0c45701aad49a98b347ede19161c3491bba5865a8d3b5bf
Deleted: d29c69a2d7ef56025f8bea1234b98a4246f340fff8ecd31ab953877307a084ce
Deleted: a90b55f35ec55a504e5131efed4a9d6ed48c793a6a22601dd16e20a82008bc0c
Deleted: b1949b7c771abaf7a4f07b16ad96162f42e70c9a1231843a7772ba8ed7bb845f
Deleted: 29d0d62805ac4e89fe637916e6202d322c2dbf10c92e948671a1973e6e7a0914
Deleted: d8c9f9d19a90cd67df88ca110ff9a8e4ea554c928445ccbdfb7c95332eec97e9
Deleted: a579793cf49ebb92953325b4d223c8b2590591d5406732056ea5041e5abc5de8
Deleted: 889b7e5b184fe559b050a9ff13eba7c863d2253b21da631fa45ecf6468a94c0a
Deleted: 576d219343a79c41e01295cb2fd59025524d2e57130be48f31fb3c9782efd577
Deleted: 90da6bf0afabe4cb2927e160c2c6d6b4e7b9eee0ec7b6ef3996681435220a690
Deleted: dc143b2f74a214c3fdee480495c274c5b472d45cc42a244c4e88bd73b482d704
Deleted: 6d2981373223cca8a6b607fb1aba825777fa1c0346aa65c25e49b320d583ed5f
Deleted: 2e569e07c5dd136f25e6f864939452769ba075acb8ff406b65f1ebb23f1bb22d
Deleted: 8d5c3b223fdfdf0d8f2ce25db6ef3596dcc30f07372b60fca5f6b5efbc1c6376
Deleted: 29fccca86f18bfff79c8c87c52bb3de63bb8c8bef7b136f3b7392fcc6caf238c
Deleted: b5c8aba0bd4f0b31413b65a72979cc6f017a669e87e7d5a7d8c8c9e4d9e24eb3
Deleted: aef4bc7ea43c59f400c3f6d104bb51c455d49a4a1c2d0d0b1a7f967dfb8cc7a4
Deleted: 819dc040cfca8481e3f2097cdb1ffd90d17e055be22ebb7f7ceb8a7c6afe2bc6
Deleted: 950b7c04b9fad770b742fde2ef23411b579e5e67d72abb85c254954af0339acb
File already uploaded: root-local.tgz
File already uploaded: resources.tgz
All sources were already uploaded.
rm 'resources.tgz'
rm 'root-local.tgz'
