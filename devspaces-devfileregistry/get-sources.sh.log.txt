======= BOOTSTRAP DOCKERFILE =======>
#
# Copyright (c) 2018-2022 Red Hat, Inc.
# This program and the accompanying materials are made
# available under the terms of the Eclipse Public License 2.0
# which is available at https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#   Red Hat, Inc. - initial API and implementation
#   IBM Corporation - implementation
#

# Builder: check meta.yamls and create index.json
# registry.access.redhat.com/ubi8/python-38
FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 as builder
USER 0

ARG BOOTSTRAP=true
ENV BOOTSTRAP=${BOOTSTRAP}
# if not defined or string is null, allow all registries/tags in list_referenced_images
# otherwise restrict to only those space-separated registries/tags; if others found, build will fail
# useful for failing build if quay images in an RC, or wrong devspaces image tag (3.2 in 3.1 build)
ARG ALLOWED_REGISTRIES=""
ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
ARG ALLOWED_TAGS=""
ENV ALLOWED_TAGS=${ALLOWED_TAGS}

COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
COPY ./build/dockerfiles/rhel.install.sh /tmp
RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

COPY ./build/scripts ./versions.json /build/
COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
COPY ./VERSION /
COPY ./devfiles /build/devfiles
WORKDIR /build/

RUN ./generate_devworkspace_templates.sh
RUN chmod -R g+rwX /build/resources

# validate devfile content
RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
RUN ./check_mandatory_fields.sh devfiles

# Cache projects in DS 
COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 

# don't do swaps, or we end up with missing content if built on s390x or ppc64le worker
# RUN ./swap_yamlfiles.sh devfiles
# RUN ./swap_images.sh devfiles
RUN ./index.sh > /build/devfiles/index.json && \
    ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt && \
    ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt && \
    chmod -R g+rwX /build/devfiles

<======= BOOTSTRAP DOCKERFILE =======
======= START BOOTSTRAP BUILD =======>
STEP 1/23: FROM registry-proxy.engineering.redhat.com/rh-osbs/ubi8-python-38:1-100 AS builder
STEP 2/23: USER 0
--> b9500d9be0f
STEP 3/23: ARG BOOTSTRAP=true
--> 005f67766e2
STEP 4/23: ENV BOOTSTRAP=${BOOTSTRAP}
--> e858f44bed2
STEP 5/23: ARG ALLOWED_REGISTRIES=""
--> 3965746bbed
STEP 6/23: ENV ALLOWED_REGISTRIES=${ALLOWED_REGISTRIES}
--> 66fff7ea7e3
STEP 7/23: ARG ALLOWED_TAGS=""
--> ab323c45416
STEP 8/23: ENV ALLOWED_TAGS=${ALLOWED_TAGS}
--> d617c559752
STEP 9/23: COPY ./build/dockerfiles/content_sets_rhel8.repo /etc/yum.repos.d/
--> 72f9b569066
STEP 10/23: COPY ./build/dockerfiles/rhel.install.sh /tmp
--> 4fd4c1729af
STEP 11/23: RUN /tmp/rhel.install.sh && rm -f /tmp/rhel.install.sh

Upgraded:
  bash-4.4.20-4.el8_6.ppc64le                                                   
  nodejs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le                      
  nodejs-docs-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.noarch                  
  nodejs-full-i18n-1:14.20.0-2.module+el8.6.0+16231+7c1b33d9.ppc64le            
  npm-1:6.14.17-1.14.20.0.2.module+el8.6.0+16231+7c1b33d9.ppc64le               
Installed:
  containers-common-2:1-39.module+el8.6.0+16891+aaa3bd4c.ppc64le                
  criu-3.15-3.module+el8.6.0+16771+28dfca77.ppc64le                             
  fuse-common-3.3.0-15.el8.ppc64le                                              
  fuse-overlayfs-1.9-1.module+el8.6.0+16771+28dfca77.ppc64le                    
  fuse3-3.3.0-15.el8.ppc64le                                                    
  fuse3-libs-3.3.0-15.el8.ppc64le                                               
  iptables-libs-1.8.4-22.el8.ppc64le                                            
  jansson-2.14-1.el8.ppc64le                                                    
  jq-1.6-3.el8.ppc64le                                                          
  kmod-25-19.el8.ppc64le                                                        
  libibverbs-37.2-1.el8.ppc64le                                                 
  libmnl-1.0.4-6.el8.ppc64le                                                    
  libnet-1.1.6-15.el8.ppc64le                                                   
  libnftnl-1.1.5-5.el8.ppc64le                                                  
  libpcap-14:1.9.1-5.el8.ppc64le                                                
  libslirp-4.4.0-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  nftables-1:0.9.3-25.el8.ppc64le                                               
  oniguruma-6.8.2-2.el8.ppc64le                                                 
  protobuf-c-1.3.0-6.el8.ppc64le                                                
  runc-1:1.1.3-3.module+el8.6.0+16986+c8760fe3.ppc64le                          
  skopeo-2:1.9.1-1.module+el8.6.0+16771+28dfca77.ppc64le                        
  slirp4netns-1.2.0-2.module+el8.6.0+16771+28dfca77.ppc64le                     

Collecting yq
  Downloading https://files.pythonhosted.org/packages/60/2c/ab35b5ec3b884b6e33b18ba3f6be6b94d607501fca1e5a8de22988690cdb/yq-3.1.0-py3-none-any.whl
Collecting argcomplete
  Downloading https://files.pythonhosted.org/packages/d3/e5/c5509683462e51b070df9e83e7f72c1ccfe3f733f328b4a0f06804c27278/argcomplete-2.0.0-py2.py3-none-any.whl
Collecting toml>=0.10.0
  Downloading https://files.pythonhosted.org/packages/44/6f/7120676b6d73228c96e17f1f794d8ab046fc910d781c8d151120c3f1569e/toml-0.10.2-py2.py3-none-any.whl
Collecting PyYAML>=5.3.1
  Downloading https://files.pythonhosted.org/packages/36/2b/61d51a2c4f25ef062ae3f74576b01638bebad5e045f747ff12643df63844/PyYAML-6.0.tar.gz (124kB)
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'done'
Collecting xmltodict>=0.11.0
  Downloading https://files.pythonhosted.org/packages/94/db/fd0326e331726f07ff7f40675cd86aa804bfd2e5016c727fa761c934990e/xmltodict-0.13.0-py2.py3-none-any.whl
Building wheels for collected packages: PyYAML
  Building wheel for PyYAML (PEP 517): started
  Building wheel for PyYAML (PEP 517): finished with status 'done'
  Created wheel for PyYAML: filename=PyYAML-6.0-cp38-cp38-linux_ppc64le.whl size=45333 sha256=92558334de36baec0a83d77f07e7b5b26fb94df2e0048c340d795df6fbfe4fe3
  Stored in directory: /tmp/pip-ephem-wheel-cache-kzt9pfla/wheels/95/84/67/ebeac632c63797cfbeb90128ca41073117721540dad526d213
Successfully built PyYAML
Installing collected packages: toml, PyYAML, xmltodict, argcomplete, yq
Successfully installed PyYAML-6.0 argcomplete-2.0.0 toml-0.10.2 xmltodict-0.13.0 yq-3.1.0
python: Python 3.8.12
yq: yq 3.1.0
jq: jq-1.6
--> f646eebe615
STEP 12/23: COPY ./build/scripts ./versions.json /build/
--> 13fe6f7f801
STEP 13/23: COPY ./build/scripts/clone_and_zip.sh /build/build/scripts/
--> 2ab59f55e4e
STEP 14/23: COPY ./VERSION /
--> 642923d9c18
STEP 15/23: COPY ./devfiles /build/devfiles
--> cad0d08e652
STEP 16/23: WORKDIR /build/
--> 5e77a431c0e
STEP 17/23: RUN ./generate_devworkspace_templates.sh

> core-js@2.6.12 postinstall /build/node_modules/core-js
> node -e "try{require('./postinstall')}catch(e){}"

[96mThank you for using core-js ([94m https://github.com/zloirock/core-js [96m) for polyfilling JavaScript standard library![0m

[96mThe project needs your help! Please consider supporting of core-js on Open Collective or Patreon: [0m
[96m>[94m https://opencollective.com/core-js [0m
[96m>[94m https://www.patreon.com/zloirock [0m

[96mAlso, the author of core-js ([94m https://github.com/zloirock [96m) is looking for a good job -)[0m

+ @eclipse-che/che-theia-devworkspace-handler@0.0.1-1649678182
added 120 packages from 182 contributors and audited 120 packages in 12.456s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

+ @eclipse-che/che-code-devworkspace-handler@1.64.0-dev-210b722
added 2 packages from 1 contributor and audited 239 packages in 2.898s

5 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
No sidecar policy. Setting to useDevContainer
--> 041f5c9a54e
STEP 18/23: RUN chmod -R g+rwX /build/resources
--> b3e0a261e2b
STEP 19/23: RUN ./check_referenced_images.sh devfiles --registries "${ALLOWED_REGISTRIES}" --tags "${ALLOWED_TAGS}"
 + registry.redhat.io/devspaces/code-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/machineexec-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-endpoint-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/theia-rhel8:3.3 PASS - 3.3 allowed
 + registry.redhat.io/devspaces/udi-rhel8:3.3 PASS - 3.3 allowed
 = registry.redhat.io/rhscl/mongodb-36-rhel7:1-50 PASS
--> 74042233945
STEP 20/23: RUN ./check_mandatory_fields.sh devfiles
Checking devfile 'devfiles/03_java11-maven-gradle/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-lombok/meta.yaml'
Checking devfile 'devfiles/03_java11-maven-quarkus/meta.yaml'
Checking devfile 'devfiles/04_nodejs-mongo/meta.yaml'
Checking devfile 'devfiles/04_nodejs-simple/meta.yaml'
Checking devfile 'devfiles/04_python/meta.yaml'
Checking devfile 'devfiles/05_cpp/meta.yaml'
Checking devfile 'devfiles/05_go/meta.yaml'
Checking devfile 'devfiles/05_php-cake/meta.yaml'
--> 8a4db077171
STEP 21/23: COPY ./build/dockerfiles/rhel.cache_projects.sh /tmp/ 
--> 48ab5c9d863
STEP 22/23: RUN /tmp/rhel.cache_projects.sh /build/ && rm -rf /tmp/rhel.cache_projects.sh /tmp/resources.tgz 
--> bae6aaa6e83
STEP 23/23: RUN ./index.sh > /build/devfiles/index.json &&     ./list_referenced_images.sh devfiles > /build/devfiles/external_images.txt &&     ./list_referenced_images_by_file.sh devfiles > /build/devfiles/external_images_by_devfile.txt &&     chmod -R g+rwX /build/devfiles
COMMIT devfileregistry:tmp
--> 5defaaa7802
Successfully tagged localhost/devfileregistry:tmp
5defaaa78020735b04d1c84f6e1fac956c4384b65d254bfbde385af0bc46ac20
<======= END BOOTSTRAP BUILD =======
Downloading root-local.tgz
Downloading resources.tgz
DIFF START *****
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.c78JtyQgvl/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD /tmp/tmp.FRnUlbTEcM/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD
--- /tmp/tmp.c78JtyQgvl/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-04 22:23:47.000000000 +0000
+++ /tmp/tmp.FRnUlbTEcM/lib/python3.8/site-packages/PyYAML-6.0.dist-info/RECORD	2022-11-05 22:23:04.255210869 +0000
@@ -2,7 +2,7 @@
 PyYAML-6.0.dist-info/LICENSE,sha256=jTko-dxEkP1jVwfLiOsmvXZBAqcoKVQwfT5RZ6V36KQ,1101
 PyYAML-6.0.dist-info/METADATA,sha256=Q56A1jQxEnzMMCyqgYkqM5Egvr9y18VExGF3ciGLjlY,2005
 PyYAML-6.0.dist-info/RECORD,,
-PyYAML-6.0.dist-info/WHEEL,sha256=aLXks5hcaJQ7h3QsaBp1z3dnJmBen9oUtgRUng3aYug,104
+PyYAML-6.0.dist-info/WHEEL,sha256=EqgGnsHwLeMuy-o1qe2FFb6uZwTmuDfCjXdcn9XxD8k,104
 PyYAML-6.0.dist-info/top_level.txt,sha256=rpj0IVMTisAjh_1vG3Ccf9v5jpCQwAz6cD1IVU5ZdhQ,11
 _yaml/__init__.py,sha256=04Ae_5osxahpJHa3XBZUAf4wi6XX32gR8D6X6p64GEA,1402
 _yaml/__pycache__/__init__.cpython-38.pyc,,
diff --suppress-common-lines -u -r -x '*.pyc' -x installed-files.txt /tmp/tmp.c78JtyQgvl/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL /tmp/tmp.FRnUlbTEcM/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL
--- /tmp/tmp.c78JtyQgvl/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-04 22:23:47.000000000 +0000
+++ /tmp/tmp.FRnUlbTEcM/lib/python3.8/site-packages/PyYAML-6.0.dist-info/WHEEL	2022-11-05 22:23:04.255210869 +0000
@@ -1,5 +1,5 @@
 Wheel-Version: 1.0
-Generator: bdist_wheel (0.38.1)
+Generator: bdist_wheel (0.38.2)
 Root-Is-Purelib: false
 Tag: cp38-cp38-linux_ppc64le
 
***** END DIFF
Untagged: localhost/devfileregistry:tmp
Deleted: 5defaaa78020735b04d1c84f6e1fac956c4384b65d254bfbde385af0bc46ac20
Deleted: bae6aaa6e83398fc49a330acea658b3f45c99cdd39f2fc07d90185e161f48c8d
Deleted: 48ab5c9d863173d889b19769df7e3c377b1454dd581eb50d8b79be69c2418201
Deleted: 8a4db0771719257648a47fc3e795edf0a2e04a70be5eeb5c16874bbbd493822c
Deleted: 74042233945ce4a92a6a6f0adce30a8bd798bcd9798630bd1005451dd905b3f2
Deleted: b3e0a261e2b160dbf19444b550b36953a6c1b4d529163e557f695d84f71ece62
Deleted: 041f5c9a54e2197d569551304132c784ddaf2bead7173e27bf5aca7d8032fd8f
Deleted: 5e77a431c0ecdf29ad98e48e0d10a6780fab4b08d30b83ec4ed704e7e814c9b0
Deleted: cad0d08e6523ff4f1f58019e0634b42f4473827b48d18cd9705815b3a5c96f06
Deleted: 642923d9c188c097d800a435865a72c3832d7be26775fbeb596f07879863c7d0
Deleted: 2ab59f55e4e5355efc67c881c2c53bdc557358a9a98530c6862332b9b90e2fe7
Deleted: 13fe6f7f8019991a39f186fa9c4760b6205c6b0d338a4e4907ad3c0223974163
Deleted: f646eebe61535888d57dac09bc9c61ae560be941cefde5ff513118e9daeac0ca
Deleted: 4fd4c1729af951d68a6f85349797ea37a3496c88b63453e1c89af04dfc69012e
Deleted: 72f9b5690664fa42c5759e69a16d683420628eb4f4dfa120d6f3884e13c73af5
Deleted: d617c559752575412f43fb049a7c968830c088577ac3161d766b6e86435a0aad
Deleted: ab323c454162181e0d8e74598a626e5570d0ab1a0210c78ae291e2f6fd1c92f2
Deleted: 66fff7ea7e31e7d86ed68c625b54a1950d10f1cb672d31c0795992f4505835ae
Deleted: 3965746bbed537dfa69636cf129ffd2a58a2f8f53374f6ac1d8f894d8710bc37
Deleted: e858f44bed22ef93b75ad7b112c1147776d2e4156a54d20da50d3b9fc1e2eef1
Deleted: 005f67766e28c48e20af91e55f1c055241227bf7d7011562f60bad27ec487ada
Deleted: b9500d9be0fdc6e64055b1f2f48093575cf622cd627f2fa8d5823ec4cbf95924
Uploading: root-local.tgz
File already uploaded: resources.tgz
Source upload succeeded. Don't forget to commit the sources file
rm 'resources.tgz'
rm 'root-local.tgz'
